<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© | HTML Version</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Cairo', sans-serif; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-preserve-3d { transform-style: preserve-3d; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .backface-hidden {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen p-4 transition-colors duration-500">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400">Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Frenchapeau</p>
        </header>

        <!-- **Ø¬Ø¯ÙŠØ¯**: Ù‚Ø³Ù… Ø§Ù„ØªØµÙÙŠØ© -->
        <div id="filter-container" class="mb-4 text-center hidden">
            <label for="category-filter" class="mr-2 text-gray-600 dark:text-gray-300">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©:</label>
            <select id="category-filter" class="p-2 rounded-md border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-indigo-500 focus:border-indigo-500">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
            </select>
        </div>

        <main id="app-container" class="mb-6">
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
            <div id="loading-state" class="text-center p-10 bg-white dark:bg-gray-800 rounded-2xl shadow-lg">
                <p class="text-xl font-bold text-gray-700 dark:text-gray-300">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª...</p>
                <div class="mt-4 w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-500 mx-auto"></div>
            </div>

            <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
            <div id="flashcard-container" class="hidden">
                 <div id="card-ui" class="w-full h-80 perspective-1000 cursor-pointer">
                    <div id="card-inner" class="relative w-full h-full transform-style-preserve-3d transition-transform duration-700">
                        <!-- Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠ -->
                        <div class="absolute w-full h-full backface-hidden flex flex-col justify-center items-center bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                            <div id="card-category" class="absolute top-4 right-4 text-xs font-semibold text-indigo-500 dark:text-indigo-400 bg-indigo-100 dark:bg-gray-700 px-3 py-1 rounded-full"></div>
                            <h2 id="card-french" class="text-5xl font-bold text-gray-800 dark:text-white text-center" lang="fr"></h2>
                            <button id="speak-french-btn" class="mt-6 text-gray-500 dark:text-gray-400 hover:text-indigo-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                            </button>
                            <p class="absolute bottom-6 text-gray-400 dark:text-gray-500 text-sm">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ±Ø¬Ù…Ø©</p>
                        </div>
                        <!-- Ø§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø®Ù„ÙÙŠ -->
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 flex flex-col justify-center items-center bg-indigo-500 dark:bg-indigo-700 rounded-2xl shadow-lg p-6 text-white">
                            <h3 id="card-arabic" class="text-4xl font-bold text-center"></h3>
                            <div id="card-notes" class="mt-6 text-center text-indigo-100 bg-black bg-opacity-20 p-3 rounded-lg w-full max-w-sm"></div>
                            <button id="speak-arabic-btn" class="mt-4 text-indigo-200 hover:text-white transition-colors">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
                 <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
                <div id="rating-buttons" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden animate-fade-in">
                    <button data-rating="again" class="w-full py-3 px-4 rounded-lg bg-red-500 text-white font-bold hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transition-transform transform hover:scale-105">ØµØ¹Ø¨ (Ø£Ø¹ÙØ¯)</button>
                    <button data-rating="good" class="w-full py-3 px-4 rounded-lg bg-blue-500 text-white font-bold hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-transform transform hover:scale-105">Ø¬ÙŠØ¯</button>
                    <button data-rating="easy" class="w-full py-3 px-4 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-transform transform hover:scale-105">Ø³Ù‡Ù„</button>
                </div>
            </div>
            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ -->
            <div id="session-complete" class="hidden text-center bg-white dark:bg-gray-800 rounded-2xl p-10 shadow-lg">
                <h2 class="text-2xl font-bold text-green-500">ğŸ‰ Ø±Ø§Ø¦Ø¹! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.</h2>
                <button id="restart-btn" class="mt-6 px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
            </div>
        </main>
        <footer class="text-center h-10">
            <div id="progress-container" class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="bg-indigo-600 dark:bg-indigo-500 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease-in-out;"></div>
            </div>
            <p id="progress-text" class="text-sm text-gray-500 dark:text-gray-400 mt-3"></p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
            // !!! Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø±Ø§Ø¨Ø· "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨" Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡ Ù…Ù† Google Apps Script
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwj6Rzh600lEZnoHA2T6mzKivC5vHcHZFnYzQEGZwpaH7AUwc6lq29dFTGLHHp718G-4w/exec';

            // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
            const loadingState = document.getElementById('loading-state');
            const flashcardContainer = document.getElementById('flashcard-container');
            const sessionComplete = document.getElementById('session-complete');
            const filterContainer = document.getElementById('filter-container');
            const categoryFilter = document.getElementById('category-filter');
            const cardUI = document.getElementById('card-ui');
            const cardInner = document.getElementById('card-inner');
            const cardCategory = document.getElementById('card-category');
            const cardFrench = document.getElementById('card-french');
            const cardArabic = document.getElementById('card-arabic');
            const cardNotes = document.getElementById('card-notes');
            const ratingButtons = document.getElementById('rating-buttons');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const restartBtn = document.getElementById('restart-btn');
            const speakFrenchBtn = document.getElementById('speak-french-btn');
            const speakArabicBtn = document.getElementById('speak-arabic-btn');

            let allCards = [], reviewQueue = [], currentCardIndex = 0, isFlipped = false;
            
            // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
            const speak = (text, lang) => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = lang;
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            };
            
            const fetchAndParseData = async () => {
                if (APPS_SCRIPT_URL === 'Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙŠØ¨ Ø§Ù„Ø°ÙŠ Ù†Ø³Ø®ØªÙ‡') {
                    loadingState.innerHTML = `<p class="text-red-500 font-bold">Ø®Ø·Ø£: Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Apps Script API ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.</p>`;
                    return [];
                }
                try {
                    const response = await fetch(APPS_SCRIPT_URL);
                    if (!response.ok) throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    loadingState.innerHTML = `<p class="text-red-500 font-bold">Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ØµØ­ÙŠØ­ ÙˆØ£Ù†Ùƒ Ù…Ù†Ø­Øª Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p><p class="text-sm text-gray-400 mt-2">${error.message}</p>`;
                    return [];
                }
            };

            const loadSrsData = (cardId) => {
                const data = localStorage.getItem(`srs-${cardId}`);
                if (data) {
                    const parsedData = JSON.parse(data);
                    parsedData.nextReview = new Date(parsedData.nextReview);
                    return parsedData;
                }
                return { interval: 1, easeFactor: 2.5, nextReview: new Date() };
            };

            const saveSrsData = (cardId, data) => {
                 data.nextReview = data.nextReview.toISOString();
                 localStorage.setItem(`srs-${cardId}`, JSON.stringify(data));
            };

            const displayCard = () => {
                if (reviewQueue.length === 0 || currentCardIndex >= reviewQueue.length) {
                    flashcardContainer.classList.add('hidden');
                    sessionComplete.classList.remove('hidden');
                    updateProgress(true);
                    return;
                }
                loadingState.classList.add('hidden');
                flashcardContainer.classList.remove('hidden');
                sessionComplete.classList.add('hidden');
                const card = reviewQueue[currentCardIndex];
                cardFrench.textContent = card.french;
                cardArabic.textContent = card.arabic;
                cardCategory.textContent = card.category;
                cardNotes.innerHTML = card.notes ? `<b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${card.notes}` : '';
                cardNotes.style.display = card.notes ? 'block' : 'none';
                isFlipped = false;
                cardInner.classList.remove('rotate-y-180');
                ratingButtons.classList.add('hidden');
                updateProgress();
            };

            const updateProgress = (completed = false) => {
                const total = reviewQueue.length;
                const current = completed ? total : currentCardIndex;
                const percentage = total > 0 ? (current / total) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                if (completed) {
                    progressText.textContent = `Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©! (${total}/${total})`;
                } else if(total > 0) {
                     progressText.textContent = `Ø¨Ø·Ø§Ù‚Ø© ${current + 1} Ù…Ù† ${total}`;
                } else {
                     progressText.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ø§Ù„ÙŠÙˆÙ….";
                }
            };

            const handleRating = (rating) => {
                const card = reviewQueue[currentCardIndex];
                let { interval, easeFactor } = card.srs;
                if (rating === 'again') {
                    interval = 1;
                } else if (rating === 'good') {
                    interval = Math.round(interval * easeFactor);
                } else if (rating === 'easy') {
                    easeFactor += 0.15;
                    interval = Math.round(interval * (easeFactor + 0.2));
                }
                interval = Math.min(interval, 365);
                const nextReviewDate = new Date();
                nextReviewDate.setDate(nextReviewDate.getDate() + interval);
                saveSrsData(card.id, { ...card.srs, interval, easeFactor, nextReview: nextReviewDate });
                currentCardIndex++;
                displayCard();
            };

            // **Ø¬Ø¯ÙŠØ¯**: Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const startSession = () => {
                const selectedCategory = categoryFilter.value;
                const now = new Date();

                const potentialCards = (selectedCategory === 'all')
                    ? allCards
                    : allCards.filter(card => card.category === selectedCategory);

                reviewQueue = potentialCards
                    .filter(card => card.srs.nextReview <= now)
                    .sort((a, b) => a.srs.nextReview - b.srs.nextReview);

                currentCardIndex = 0;
                sessionComplete.classList.add('hidden');
                flashcardContainer.classList.remove('hidden');
                displayCard();
            };

            // **Ø¬Ø¯ÙŠØ¯**: Ø¯Ø§Ù„Ø© Ù„Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ¦Ø§Øª
            const populateCategoryFilter = () => {
                const categories = [...new Set(allCards.map(card => card.category))];
                categoryFilter.innerHTML = '<option value="all">Ø§Ù„ÙƒÙ„</option>'; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                categories.forEach(category => {
                    if (category) {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    }
                });
                filterContainer.classList.remove('hidden');
            };

            const initializeApp = async () => {
                allCards = await fetchAndParseData();
                if (allCards.length === 0) return;
                allCards.forEach(card => card.srs = loadSrsData(card.id));
                populateCategoryFilter();
                startSession();
            };

            // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
            cardUI.addEventListener('click', () => {
                if (reviewQueue.length === 0) return;
                isFlipped = !isFlipped;
                cardInner.classList.toggle('rotate-y-180');
                ratingButtons.classList.toggle('hidden', !isFlipped);
            });
            ratingButtons.addEventListener('click', (e) => {
                if (e.target.dataset.rating) handleRating(e.target.dataset.rating);
            });
            speakFrenchBtn.addEventListener('click', (e) => { e.stopPropagation(); speak(cardFrench.textContent, 'fr-FR'); });
            speakArabicBtn.addEventListener('click', (e) => { e.stopPropagation(); speak(cardArabic.textContent, 'ar-SA'); });
            
            // **Ø¬Ø¯ÙŠØ¯**: Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙØ¦Ø©
            categoryFilter.addEventListener('change', startSession);

            restartBtn.addEventListener('click', startSession);

            initializeApp();
        });
    </script>
</body>
</html>
