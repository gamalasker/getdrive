<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø±ÙÙŠÙ‚ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap');
    * { font-family: 'Cairo', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
    .progress-bar { transition: width 0.5s ease; }
    .pulse-glow { animation: pulseGlow 2s infinite; }
    @keyframes pulseGlow { 0%,100%{ box-shadow: 0 0 20px rgba(102,126,234,.4)} 50%{ box-shadow:0 0 30px rgba(102,126,234,.8)} }
    .study-timer { background: linear-gradient(45deg, #ff6b6b, #feca57); }
    .achievement-badge { background: linear-gradient(45deg, #48cae4, #023e8a); }
    .timer-mode { cursor: pointer; transition: all .2s ease; }
    .timer-mode.active { outline: 2px solid #fff; transform: scale(1.03); }
    .priority-btn{ cursor:pointer; transition: all .2s ease; }
    .priority-btn.selected{ border-color:#3b82f6; background:#dbeafe; transform: scale(1.03); }
    .floating-notification { position: fixed; top: 20px; right: 20px; z-index: 1000; animation: slideIn .4s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0 } to { transform: translateX(0); opacity: 1} }
    .smart-schedule{ background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
    .weekly-chart-container{ background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .challenge-card{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .nav-btn-active { background: #2563eb; color: #fff; }
    .nav-btn { background: #e5e7eb; color: #374151; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white p-6 shadow-lg">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-4 space-x-reverse">
        <div class="text-4xl">ğŸ“</div>
        <div>
          <h1 class="text-3xl font-bold">Ø±ÙÙŠÙ‚ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h1>
          <p class="text-blue-100">Ø±ÙÙŠÙ‚Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù†Ø¬Ø§Ø­</p>
        </div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold" id="currentTime"></div>
        <div class="text-sm text-blue-100">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="max-w-6xl mx-auto p-6">
    <div class="bg-white rounded-2xl shadow-lg p-4">
      <div class="flex space-x-4 space-x-reverse">
        <button onclick="showPage('dashboard', this)" id="dashboardBtn" class="px-6 py-3 rounded-lg font-semibold transition-colors nav-btn-active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button onclick="showPage('analytics', this)" id="analyticsBtn" class="px-6 py-3 rounded-lg font-semibold transition-colors nav-btn">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
        <button onclick="showPage('settings', this)" id="settingsBtn" class="px-6 py-3 rounded-lg font-semibold transition-colors nav-btn">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </div>
  </nav>

  <!-- Dashboard Page -->
  <div id="dashboardPage" class="max-w-6xl mx-auto p-6">
    <!-- Daily Motivation -->
    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-6 mb-8 text-white shadow-lg">
      <div class="flex items-center space-x-4 space-x-reverse">
        <div class="text-4xl">âœ¨</div>
        <div>
          <h2 class="text-xl font-bold mb-2">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</h2>
          <p class="text-lg" id="dailyMotivation">ÙƒÙ„ Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© ØªÙ‚Ø±Ø¨Ùƒ Ù…Ù† Ù‡Ø¯ÙÙƒ Ø§Ù„ÙƒØ¨ÙŠØ±.</p>
        </div>
      </div>
    </div>

    <!-- Study Stats Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
            <p class="text-3xl font-bold text-blue-600" id="todayHours">0</p>
          </div>
          <div class="text-4xl">â°</div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
            <p class="text-3xl font-bold text-green-600" id="completedSubjects">0/0</p>
          </div>
          <div class="text-4xl">âœ…</div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</p>
            <p class="text-3xl font-bold text-purple-600" id="badges">0</p>
          </div>
          <div class="text-4xl">ğŸ†</div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</p>
            <p class="text-3xl font-bold text-orange-600" id="streakDays">0</p>
          </div>
          <div class="text-4xl">ğŸ”¥</div>
        </div>
      </div>
      <!-- New Points Card -->
      <div class="bg-white rounded-xl p-6 shadow-lg card-hover">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-600 text-sm">Ù†Ù‚Ø§Ø·ÙŠ</p>
            <p class="text-3xl font-bold text-yellow-500" id="myPoints">0</p>
          </div>
          <div class="text-4xl">âœ¨</div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Subjects Panel -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
            <button onclick="openAddSubject()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="subjectsContainer"></div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="space-y-6">
        <!-- Daily Challenge -->
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-gray-800">âœ… Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
          <div id="dailyChallengeContainer" class="bg-blue-50 rounded-lg p-4 text-center">
            <!-- Dynamic content will be injected here -->
          </div>
        </div>

        <!-- Study Timer -->
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-gray-800">â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h3>
          <div class="text-center">
            <div class="study-timer rounded-full w-32 h-32 mx-auto flex items-center justify-center mb-4 pulse-glow">
              <span class="text-3xl font-bold text-white" id="timerDisplay">25:00</span>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
              <button class="timer-mode bg-red-500 text-white py-2 rounded-lg text-sm active" onclick="setTimerMode('focus', this)">ğŸ¯ ØªØ±ÙƒÙŠØ²</button>
              <button class="timer-mode bg-green-500 text-white py-2 rounded-lg text-sm" onclick="setTimerMode('break', this)">â˜• Ø§Ø³ØªØ±Ø§Ø­Ø©</button>
              <button class="timer-mode bg-blue-500 text-white py-2 rounded-lg text-sm" onclick="setTimerMode('longbreak', this)">ğŸ›‹ï¸ Ø·ÙˆÙŠÙ„Ø©</button>
            </div>
            <div class="space-y-2">
              <button onclick="startTimer()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">â–¶ï¸ Ø§Ø¨Ø¯Ø£</button>
              <button onclick="pauseTimer()" class="w-full bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700 transition-colors">â¸ï¸ ØªÙˆÙ‚Ù</button>
              <button onclick="resetTimer()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
          </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h3>
          <div class="space-y-3" id="achievementsContainer"></div>
        </div>

        <!-- Smart Tips -->
        <div class="bg-white rounded-2xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø°ÙƒÙŠØ©</h3>
          <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-sm text-blue-800" id="smartTip">Ù‚Ø³Ù‘Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØµØ¹Ø¨Ø© Ø¥Ù„Ù‰ Ù…Ù‡Ø§Ù… ØµØºÙŠØ±Ø© Ø¨ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©.</p>
            <div class="flex justify-between mt-3">
              <button onclick="likeAdvice()" class="text-green-600 hover:text-green-700">ğŸ‘ Ù…ÙÙŠØ¯</button>
              <button onclick="nextAdvice()" class="text-blue-600 hover:text-blue-700">ğŸ”„ Ù†ØµÙŠØ­Ø© Ø£Ø®Ø±Ù‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Weekly Progress Chart -->
    <div class="bg-white rounded-2xl p-6 shadow-lg mt-8">
      <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“Š ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>
      <div id="weeklyProgress" class="grid grid-cols-7 gap-2"></div>
    </div>
  </div>

  <!-- Analytics Page -->
  <div id="analyticsPage" class="max-w-6xl mx-auto p-6 hidden">
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl p-6 mb-8 text-white shadow-lg">
      <div class="flex items-center space-x-4 space-x-reverse">
        <div class="text-4xl">ğŸ“Š</div>
        <div>
          <h2 class="text-3xl font-bold mb-2">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</h2>
          <p class="text-lg">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø£Ø¯Ø§Ø¦Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ÙˆØªÙ‚Ø¯Ù…Ùƒ</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 shadow-lg text-center">
        <div class="text-4xl mb-2">ğŸ“ˆ</div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</h3>
        <div class="text-3xl font-bold text-green-600" id="overallPerformance">0%</div>
        <p class="text-sm text-gray-600 mt-2" id="overallPerformanceText"></p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg text-center">
        <div class="text-4xl mb-2">â±ï¸</div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</h3>
        <div class="text-3xl font-bold text-blue-600" id="totalStudyHours">0</div>
        <p class="text-sm text-gray-600 mt-2">Ø³Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-lg text-center">
        <div class="text-4xl mb-2">ğŸ¯</div>
        <h3 class="text-lg font-bold text-gray-800 mb-2">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h3>
        <div class="text-3xl font-bold text-purple-600" id="commitmentRate">0%</div>
        <p class="text-sm text-gray-600 mt-2" id="commitmentRateText"></p>
      </div>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-lg mb-8">
      <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“š ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
      <div class="space-y-4" id="subjectAnalysis"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ• Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</h3>
        <div class="space-y-4" id="studyPatterns">
          <!-- Dynamic content will be injected here -->
        </div>
      </div>
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-4 text-gray-800">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
        <div class="space-y-3" id="recentAchievements">
          <!-- Dynamic content will be injected here -->
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl p-6 shadow-lg">
      <h3 class="text-2xl font-bold mb-6 text-gray-800">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
      <div class="grid grid-cols-4 gap-4 mb-4">
        <div class="text-center text-sm font-semibold text-gray-600">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</div>
        <div class="text-center text-sm font-semibold text-gray-600">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
        <div class="text-center text-sm font-semibold text-gray-600">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«</div>
        <div class="text-center text-sm font-semibold text-gray-600">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹</div>
      </div>
      <div class="grid grid-cols-4 gap-4" id="monthlyProgress"></div>
    </div>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" class="max-w-6xl mx-auto p-6 hidden">
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 mb-8 text-white shadow-lg">
      <div class="flex items-center space-x-4 space-x-reverse">
        <div class="text-4xl">âš™ï¸</div>
        <div>
          <h2 class="text-3xl font-bold mb-2">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
          <p class="text-lg">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Data Management -->
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center"><span class="text-3xl ml-3">ğŸ—‚ï¸</span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <div class="space-y-4">
          <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="font-bold text-red-800 mb-2">âš ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
            <p class="text-sm text-red-700 mb-4">Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.</p>
            <button onclick="showConfirmModal('resetData')" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors font-semibold">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          </div>
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-bold text-yellow-800 mb-2">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙ‚Ø·</h4>
            <p class="text-sm text-yellow-700 mb-4">Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯.</p>
            <button onclick="showConfirmModal('resetStats')" class="bg-yellow-600 text-white px-6 py-2 rounded-lg hover:bg-yellow-700 transition-colors font-semibold">ğŸ“Š Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
          </div>
        </div>
      </div>

      <!-- Weekly Challenge -->
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center"><span class="text-3xl ml-3">ğŸ†</span>Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù‡Ø¯Ù Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</label>
            <div class="flex items-center space-x-2 space-x-reverse">
              <input type="range" id="weeklyGoalSlider" min="10" max="50" value="25" onchange="updateWeeklyGoal()" class="flex-1"/>
              <span id="weeklyGoalDisplay" class="font-bold text-blue-600 text-lg min-w-[3rem]">25</span>
              <span class="text-gray-600">Ø³Ø§Ø¹Ø©</span>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
            <div class="space-y-2" id="challengeSubjects"></div>
          </div>
          <button onclick="saveWeeklyChallenge()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
        </div>
      </div>
    </div>

    <!-- Study Schedule -->
    <div class="bg-white rounded-2xl p-6 shadow-lg mt-8">
      <h3 class="text-2xl font-bold mb-6 text-gray-800 flex items-center"><span class="text-3xl ml-3">ğŸ“…</span>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>

      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
          <tr class="bg-gray-50">
            <th class="border border-gray-300 p-3 text-right font-bold">Ø§Ù„ÙŠÙˆÙ…</th>
            <th class="border border-gray-300 p-3 text-center font-bold">Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©<br><span class="text-sm font-normal">(9:00 - 12:00)</span></th>
            <th class="border border-gray-300 p-3 text-center font-bold">ÙØªØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±<br><span class="text-sm font-normal">(2:00 - 5:00)</span></th>
            <th class="border border-gray-300 p-3 text-center font-bold">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©<br><span class="text-sm font-normal">(7:00 - 10:00)</span></th>
            <th class="border border-gray-300 p-3 text-center font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
          </tr>
          </thead>
          <tbody id="scheduleTable"></tbody>
        </table>
      </div>

      <div class="mt-6 flex flex-wrap gap-3 items-center justify-between">
        <div class="flex gap-3">
          <button onclick="generateSchedule()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">ğŸ² Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          <button onclick="openEditCellModal()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">â• Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© ÙŠØ¯ÙˆÙŠØ©</button>
        </div>
        <div class="text-lg font-bold text-gray-800">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: <span id="totalWeeklyHours" class="text-blue-600">0</span> Ø³Ø§Ø¹Ø©
        </div>
      </div>
      <p class="text-sm text-gray-500 mt-2">ØªÙ„Ù…ÙŠØ­: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ Ø®Ø§Ù†Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹.</p>
    </div>

    <!-- Current Challenge Status -->
    <div class="bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-6 mt-8 text-white shadow-lg">
      <h3 class="text-2xl font-bold mb-4 flex items-center"><span class="text-3xl ml-3">ğŸ¯</span>Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center"><div class="text-3xl font-bold" id="challengeProgress">0/0</div><div class="text-sm opacity-90">Ø³Ø§Ø¹Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div></div>
        <div class="text-center"><div class="text-3xl font-bold" id="challengeDaysLeft">0</div><div class="text-sm opacity-90">Ø£ÙŠØ§Ù… Ù…ØªØ¨Ù‚ÙŠØ©</div></div>
        <div class="text-center"><div class="text-3xl font-bold" id="challengeCompletion">0%</div><div class="text-sm opacity-90">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div></div>
      </div>
      <div class="mt-4">
        <div class="bg-white bg-opacity-30 rounded-full h-3">
          <div class="bg-white rounded-full h-3 transition-all duration-500" style="width: 0%" id="challengeProgressBar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div id="addSubjectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</label>
          <input type="text" id="subjectName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡"/>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
          <select id="difficulty" onchange="updateHoursRecommendation()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="easy">Ø³Ù‡Ù„ ğŸ˜Š</option>
            <option value="medium">Ù…ØªÙˆØ³Ø· ğŸ¤”</option>
            <option value="hard">ØµØ¹Ø¨ ğŸ˜¤</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­ØµØµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</label>
          <div class="flex items-center space-x-2 space-x-reverse">
            <input type="range" id="weeklyHoursSlider" min="1" max="15" value="4" onchange="updateHoursDisplay()" class="flex-1"/>
            <span id="hoursDisplay" class="font-bold text-blue-600 text-lg min-w-[3rem]">4</span>
            <span class="text-gray-600">Ø³Ø§Ø¹Ø©</span>
          </div>
          <div class="mt-2 text-sm text-gray-600" id="hoursRecommendation">Ø§Ù„ØªÙˆØµÙŠØ©: 4-6 Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©</div>
        </div>
        <div class="flex space-x-4 space-x-reverse pt-4">
          <button onclick="saveSubject()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">Ø­ÙØ¸</button>
          <button onclick="closeAddSubject()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors font-semibold">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Cell Modal (Manual schedule) -->
  <div id="editCellModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-6 text-gray-800">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¬Ù„Ø³Ø©</h3>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙŠÙˆÙ…</label>
            <select id="editDaySelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option>Ø§Ù„Ø³Ø¨Øª</option><option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option><option>Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙØªØ±Ø©</label>
            <select id="editPeriodSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="morning">Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©</option>
              <option value="afternoon">Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±</option>
              <option value="evening">Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
          <select id="editSubjectSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
          <input id="editHoursInput" type="number" min="1" max="4" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
        </div>
        <div class="grid grid-cols-3 gap-3 pt-2">
          <button onclick="saveCellEdit()" class="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">Ø­ÙØ¸</button>
          <button onclick="removeCell()" class="bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition-colors font-semibold">Ø­Ø°Ù</button>
          <button onclick="closeEditCellModal()" class="bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 transition-colors font-semibold">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
      <h3 class="text-xl font-bold mb-4 text-gray-800" id="confirmTitle"></h3>
      <p class="text-gray-600 mb-6" id="confirmMessage"></p>
      <div class="flex justify-center space-x-4 space-x-reverse">
        <button id="confirmYesBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors font-semibold">Ù†Ø¹Ù…</button>
        <button id="confirmNoBtn" class="flex-1 bg-gray-300 text-gray-800 py-2 rounded-lg hover:bg-gray-400 transition-colors font-semibold">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div >

  <!-- Notifications -->
  <div id="notificationContainer" class="fixed top-6 right-6 z-50 space-y-3"></div>

  <script>
    // ===== Data =====
    const DAYS = ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
    const PERIODS = ['morning','afternoon','evening'];
    const PERIOD_LABELS = { morning:'Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©', afternoon:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±', evening:'Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ©' };
    const PERIOD_HOURS = { morning:3, afternoon:3, evening:3 }; // Max hours per period
    
    let subjects = [
      { id: 1, name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', icon: 'ğŸ“', weeklyHours: 6, progress: 0, difficulty: 'hard', color: 'blue', isStudying: false, studyLog: [] },
      { id: 2, name: 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', icon: 'âš›ï¸', weeklyHours: 5, progress: 0, difficulty: 'hard', color: 'purple', isStudying: false, studyLog: [] },
      { id: 3, name: 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', icon: 'ğŸ§ª', weeklyHours: 4, progress: 0, difficulty: 'medium', color: 'green', isStudying: false, studyLog: [] },
      { id: 4, name: 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', icon: 'ğŸ“–', weeklyHours: 4, progress: 0, difficulty: 'easy', color: 'orange', isStudying: false, studyLog: [] },
      { id: 5, name: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', icon: 'ğŸ›ï¸', weeklyHours: 3, progress: 0, difficulty: 'medium', color: 'red', isStudying: false, studyLog: [] }
    ];
    let achievements = [
      { name: 'Ø¨Ø¯Ø§ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©', description: 'Ø£ÙƒÙ…Ù„ Ø£ÙˆÙ„ Ø¬Ù„Ø³Ø© Ù…Ø°Ø§ÙƒØ±Ø©', icon: 'ğŸ‰', earned: false, condition: (data) => data.studyLog.length >= 1 },
      { name: 'Ø§Ù„Ù…Ø«Ø§Ø¨Ø±', description: 'Ø£ÙƒÙ…Ù„ 7 Ø¬Ù„Ø³Ø§Øª Ù…Ø°Ø§ÙƒØ±Ø© ÙÙŠ Ø£Ø³Ø¨ÙˆØ¹', icon: 'ğŸ’ª', earned: false, condition: (data) => data.studyLog.filter(log => new Date() - new Date(log.date) <= 7 * 24 * 60 * 60 * 1000).length >= 7 },
      { name: 'Ø¨Ø·Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', description: 'Ø£ÙƒÙ…Ù„ 10 Ø³Ø§Ø¹Ø§Øª Ø¯Ø±Ø§Ø³Ø© ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', icon: 'ğŸ†', earned: false, condition: (data) => data.subjects.find(s => s.name === 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª')?.studyLog.reduce((sum, log) => sum + (log.minutes / 60), 0) >= 10 },
      { name: 'Ø¹Ø§Ø´Ù‚ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', description: 'Ø£ÙƒÙ…Ù„ 10 Ø³Ø§Ø¹Ø§Øª Ø¯Ø±Ø§Ø³Ø© ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', icon: 'ğŸ“š', earned: false, condition: (data) => data.subjects.find(s => s.name === 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')?.studyLog.reduce((sum, log) => sum + (log.minutes / 60), 0) >= 10 }
    ];
    let weeklyChallenge = {
      goal: 25,
      completed: 0,
      subjects: [], // array of subject ids
      startDate: new Date().toISOString(),
      schedule: {} // { ÙŠÙˆÙ…: { morning:{subjectId, hours, manual}, ... } }
    };
    let studyLog = []; // { date: ISOString, minutes: number, subjectId: number }
    let points = 0;
    let dailyChallenge = {}; // { date: 'YYYY-MM-DD', description: '...', completed: false, points: 0, condition: () => {} }

    let timer = { minutes: 25, seconds: 0, isRunning: false, interval: null, mode: 'focus' };
    let currentStudyingSubject = null;
    let weeklyChart = null;
    let confirmCallback = null;

    const tips = [
      'Ù‚Ø³Ù‘Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØµØ¹Ø¨Ø© Ø¥Ù„Ù‰ Ù…Ù‡Ø§Ù… ØµØºÙŠØ±Ø© Ø¨ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯ Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©.',
      'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ².',
      'Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚ ÙƒÙ„ 25 Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·.',
      'Ø§Ø±Ø¨Ø· Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø¨Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø­ÙŠØ§ØªÙƒ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ°ÙƒØ±.',
      'Ø¯ÙˆÙ‘Ù† 3 Ù†Ù‚Ø§Ø· ØªØ¹Ù„Ù‘Ù…ØªÙ‡Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø¬Ù„Ø³Ø©.'
    ];
    const motivations = [
      'ÙƒÙ„ Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© ØªÙ‚Ø±Ø¨Ùƒ Ù…Ù† Ù‡Ø¯ÙÙƒ Ø§Ù„ÙƒØ¨ÙŠØ±.',
      'Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù‚ÙˆØ©ØŒ ÙˆØ§Ù„ØªØ¹Ù„Ù… Ø±Ø­Ù„Ø© Ù„Ø§ ØªÙ†ØªÙ‡ÙŠ.',
      'Ø§Ù„ÙŠÙˆÙ… Ø£ÙØ¶Ù„ Ù…Ù† Ø£Ù…Ø³ØŒ ÙˆØºØ¯Ø§Ù‹ Ø³ÙŠÙƒÙˆÙ† Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„ÙŠÙˆÙ….',
      'Ø§Ù„ØµØ¨Ø± ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© Ù‡Ù…Ø§ Ù…ÙØªØ§Ø­Ø§ Ø§Ù„Ù†Ø¬Ø§Ø­.'
    ];
    
    // Daily Challenge Templates
    const dailyChallengeTemplates = [
      {
        description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù„Ø³ØªÙŠÙ† Ù…Ø°Ø§ÙƒØ±Ø©.',
        points: 20,
        condition: () => studyLog.filter(log => new Date(log.date).toDateString() === new Date().toDateString()).length >= 2
      },
      {
        description: 'Ø°Ø§ÙƒØ± Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù„Ù…Ø¯Ø© 45 Ø¯Ù‚ÙŠÙ‚Ø©.',
        points: 30,
        condition: () => studyLog.filter(log => new Date(log.date).toDateString() === new Date().toDateString() && log.minutes >= 45).length >= 1
      },
      {
        description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù„Ø³Ø© Ù…Ø°Ø§ÙƒØ±Ø© ØµØ¨Ø§Ø­ÙŠØ© (Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¹Ø© 12 Ø¸Ù‡Ø±Ø§Ù‹).',
        points: 25,
        condition: () => studyLog.filter(log => new Date(log.date).toDateString() === new Date().toDateString() && new Date(log.date).getHours() < 12).length >= 1
      },
      {
        description: 'Ø£ÙƒÙ…Ù„ Ø¬Ù„Ø³Ø© Ù…Ø°Ø§ÙƒØ±Ø© ÙÙŠ Ù…Ø§Ø¯Ø© "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª".',
        points: 20,
        condition: () => {
          const mathSubject = subjects.find(s => s.name === 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª');
          return mathSubject ? studyLog.filter(log => new Date(log.date).toDateString() === new Date().toDateString() && log.subjectId === mathSubject.id).length >= 1 : false;
        }
      }
    ];

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', () => {
      loadFromLocalStorage();
      updateTime();
      setInterval(updateTime, 1000);
      generateDailyChallenge();
      renderDashboard();
      renderAnalytics();
      renderSettings();
      setInterval(() => setSmartTip(), 10000);
      setSmartTip();
      updateChallengeProgress();
      setupConfirmModal();
    });

    // ===== UI Rendering =====
    function renderDashboard() {
      updateDailyMotivation();
      renderDailyChallenge();
      renderSubjects();
      renderAchievements();
      updateDashboardStats();
    }

    function renderAnalytics() {
      updateAnalyticsStats();
      renderSubjectAnalysis();
      renderMonthlyProgress();
      renderStudyPatterns();
      renderRecentAchievements();
      initializeWeeklyChart();
    }

    function renderSettings() {
      renderChallengeSubjects();
      renderScheduleTable();
      computeWeeklyTotals();
    }

    function showPage(page, btn) {
      ['dashboard','analytics','settings'].forEach(p => {
        document.getElementById(p + 'Page').classList.toggle('hidden', p !== page);
        const b = document.getElementById(p+'Btn');
        if (p === page) { b.classList.remove('nav-btn'); b.classList.add('nav-btn-active'); }
        else { b.classList.add('nav-btn'); b.classList.remove('nav-btn-active'); }
      });
      if (page === 'analytics') {
        renderAnalytics();
      }
    }

    // Header time & motivation
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit', hour12: true });
      document.getElementById('currentTime').textContent = timeString;
    }
    function updateDailyMotivation() {
      document.getElementById('dailyMotivation').textContent = motivations[Math.floor(Math.random()*motivations.length)];
    }
    function setSmartTip(){ document.getElementById('smartTip').textContent = tips[Math.floor(Math.random()*tips.length)]; }
    function likeAdvice(){ showNotification('ğŸ‘ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£Ù† Ø§Ù„Ù†ØµÙŠØ­Ø© Ù…ÙÙŠØ¯Ø©', 'success'); }
    function nextAdvice(){ setSmartTip(); showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙŠØ­Ø©', 'info'); }

    // Dashboard Stats
    function updateDashboardStats() {
      const today = new Date().toLocaleDateString();
      const todayHours = studyLog.filter(log => new Date(log.date).toLocaleDateString() === today)
                                 .reduce((sum, log) => sum + log.minutes, 0) / 60;
      document.getElementById('todayHours').textContent = todayHours.toFixed(1);
      
      const completedSubjects = subjects.filter(s => s.progress >= 80).length;
      document.getElementById('completedSubjects').textContent = `${completedSubjects}/${subjects.length}`;
      
      const earnedBadges = achievements.filter(a => a.earned).length;
      document.getElementById('badges').textContent = earnedBadges;
      
      const streakDays = calculateStreak();
      document.getElementById('streakDays').textContent = streakDays;

      document.getElementById('myPoints').textContent = points;

      renderWeeklyProgressBars();
    }

    function calculateStreak() {
      if (studyLog.length === 0) return 0;
      const uniqueDates = [...new Set(studyLog.map(log => new Date(log.date).toLocaleDateString()))].sort();
      let streak = 0;
      let yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      let currentDay = new Date();

      if (uniqueDates.includes(currentDay.toLocaleDateString())) {
          streak = 1;
      }
      
      for (let i = uniqueDates.length - 1; i >= 0; i--) {
        const currentDate = new Date(uniqueDates[i]);
        const previousDate = new Date(uniqueDates[i-1]);

        if (i === uniqueDates.length -1) {
            if (currentDate.toLocaleDateString() === new Date().toLocaleDateString() || currentDate.toLocaleDateString() === yesterday.toLocaleDateString()) {
                streak = 1;
            } else {
                streak = 0;
            }
        }
        
        const diffInDays = (currentDate - previousDate) / (1000 * 60 * 60 * 24);
        if (diffInDays === 1) {
          streak++;
        } else if (diffInDays > 1) {
          break;
        }
      }
      return streak;
    }

    // Daily Challenge
    function generateDailyChallenge() {
        const today = new Date().toISOString().slice(0, 10);
        if (dailyChallenge.date === today && dailyChallenge.description) {
            renderDailyChallenge();
            return;
        }
        const newChallenge = dailyChallengeTemplates[Math.floor(Math.random() * dailyChallengeTemplates.length)];
        dailyChallenge = {
            date: today,
            description: newChallenge.description,
            completed: false,
            points: newChallenge.points,
            condition: newChallenge.condition
        };
        saveToLocalStorage();
        renderDailyChallenge();
    }

    function renderDailyChallenge() {
        const container = document.getElementById('dailyChallengeContainer');
        if (dailyChallenge.completed) {
            container.innerHTML = `
              <p class="text-xl text-green-600 font-bold mb-2">âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ!</p>
              <p class="text-sm text-gray-800">${dailyChallenge.description}</p>
              <p class="text-lg font-bold text-yellow-500 mt-2">Ù„Ù‚Ø¯ ÙƒØ³Ø¨Øª ${dailyChallenge.points} Ù†Ù‚Ø§Ø·!</p>
            `;
        } else {
            container.innerHTML = `
              <p class="text-lg text-blue-800 font-semibold mb-2">${dailyChallenge.description}</p>
              <p class="text-sm text-gray-600">Ø£ÙƒÙ…Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ <span class="font-bold text-blue-600">${dailyChallenge.points}</span> Ù†Ù‚Ø·Ø©.</p>
            `;
        }
    }

    function checkDailyChallengeCompletion() {
        if (dailyChallenge.completed) return;
        if (dailyChallenge.condition && dailyChallenge.condition()) {
            dailyChallenge.completed = true;
            points += dailyChallenge.points;
            renderDailyChallenge();
            updateDashboardStats();
            showNotification(`ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆÙƒØ³Ø¨Øª ${dailyChallenge.points} Ù†Ù‚Ø·Ø©.`, 'success');
            saveToLocalStorage();
        }
    }

    // Subjects
    function renderSubjects() {
      const container = document.getElementById('subjectsContainer');
      container.innerHTML = '';
      const colors = { blue:'from-blue-500 to-blue-600', purple:'from-purple-500 to-purple-600', green:'from-green-500 to-green-600', orange:'from-orange-500 to-orange-600', red:'from-red-500 to-red-600', teal:'from-teal-500 to-teal-600' };
      const diffEmoji = { easy:'ğŸ˜Š', medium:'ğŸ¤”', hard:'ğŸ˜¤' };
      subjects.forEach(s => {
        const studyingClass = s.isStudying ? ' ring-4 ring-yellow-400 ring-opacity-75 shadow-2xl transform scale-105' : '';
        const card = document.createElement('div');
        card.className = `bg-gradient-to-br ${colors[s.color]||colors.blue} rounded-xl p-6 text-white card-hover${studyingClass}`;
        card.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3 space-x-reverse">
              <span class="text-3xl">${s.icon}</span>
              <div>
                <h3 class="font-bold text-lg">${s.name}</h3>
                <p class="text-sm opacity-90">${s.weeklyHours} Ø­ØµØµ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹</p>
              </div>
            </div>
            <span class="text-2xl">${diffEmoji[s.difficulty]}</span>
          </div>
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-2"><span>Ø§Ù„ØªÙ‚Ø¯Ù…</span><span>${s.progress}%</span></div>
            <div class="bg-white bg-opacity-30 rounded-full h-2"><div class="bg-white rounded-full h-2 progress-bar" style="width:${s.progress}%"></div></div>
          </div>
          <button onclick="startStudySession(${s.id})" class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 py-2 rounded-lg transition-all font-semibold ${s.isStudying ? 'animate-pulse':''}">
            ${s.isStudying ? 'ğŸ”¥ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©...' : 'â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¢Ù†'}
          </button>`;
        container.appendChild(card);
      });
    }

    // Achievements
    function renderAchievements() {
      const container = document.getElementById('achievementsContainer');
      container.innerHTML = '';
      achievements.forEach(a => {
        const el = document.createElement('div');
        el.className = `flex items-center space-x-3 space-x-reverse p-3 rounded-lg ${a.earned ? 'achievement-badge text-white' : 'bg-gray-100 text-gray-400'}`;
        el.innerHTML = `<span class="text-2xl">${a.icon}</span><span class="font-semibold">${a.name}</span>`;
        container.appendChild(el);
      });
    }

    // Weekly progress bars (dashboard)
    function renderWeeklyProgressBars() {
      const container = document.getElementById('weeklyProgress');
      container.innerHTML = '';
      const weeklyData = getWeeklyStudyHours();
      const max = Math.max(...Object.values(weeklyData), 1);
      DAYS.forEach(day => {
        const h = weeklyData[day] || 0;
        const percentage = (h / max) * 100;
        const color = h > 3 ? 'bg-green-500' : h > 1 ? 'bg-yellow-500' : 'bg-gray-300';
        const div = document.createElement('div');
        div.className = 'text-center';
        div.innerHTML = `<div class="h-20 flex-1 ${color} rounded-lg mb-2 flex items-end justify-center" style="height:${Math.max(percentage, 10)}%"><span class="text-white text-xs font-bold mb-1">${h.toFixed(1)}Ø³</span></div>`;
        container.appendChild(div);
      });
    }

    function getWeeklyStudyHours() {
      const weeklyHours = {};
      const today = new Date();
      const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
      studyLog.forEach(log => {
        const logDate = new Date(log.date);
        if (logDate >= startOfWeek) {
          const day = DAYS[logDate.getDay()];
          weeklyHours[day] = (weeklyHours[day] || 0) + log.minutes / 60;
        }
      });
      return weeklyHours;
    }

    // Analytics Page Functions
    function updateAnalyticsStats() {
      const totalHours = studyLog.reduce((sum, log) => sum + log.minutes, 0) / 60;
      document.getElementById('totalStudyHours').textContent = totalHours.toFixed(0);

      // Overall Performance Calculation
      const totalProgress = subjects.reduce((sum, s) => sum + s.progress, 0);
      const overallPerformance = subjects.length > 0 ? (totalProgress / subjects.length) : 0;
      document.getElementById('overallPerformance').textContent = `${overallPerformance.toFixed(0)}%`;
      if (overallPerformance >= 80) {
        document.getElementById('overallPerformanceText').textContent = 'Ù…Ù…ØªØ§Ø²! Ø§Ø³ØªÙ…Ø± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ÙˆØ§Ù„';
      } else if (overallPerformance >= 60) {
        document.getElementById('overallPerformanceText').textContent = 'Ø¬ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø£ÙƒØ«Ø±';
      } else {
        document.getElementById('overallPerformanceText').textContent = 'ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¨Ø°Ù„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø¯';
      }

      // Commitment Rate Calculation
      const totalSessions = studyLog.length;
      const totalPlannedSessions = DAYS.reduce((sum, day) => {
        return sum + Object.values(weeklyChallenge.schedule[day] || {}).length;
      }, 0);
      const commitmentRate = totalPlannedSessions > 0 ? (totalSessions / totalPlannedSessions) * 100 : 0;
      document.getElementById('commitmentRate').textContent = `${commitmentRate.toFixed(0)}%`;
      if (commitmentRate >= 90) {
        document.getElementById('commitmentRateText').textContent = 'Ø§Ù„ØªØ²Ø§Ù… Ù…Ù…ØªØ§Ø² Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„';
      } else if (commitmentRate >= 70) {
        document.getElementById('commitmentRateText').textContent = 'Ø§Ù„ØªØ²Ø§Ù… Ø¬ÙŠØ¯ØŒ Ø­Ø§ÙˆÙ„ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ø§Ù†ØªØ¸Ø§Ù…Ø§Ù‹';
      } else {
        document.getElementById('commitmentRateText').textContent = 'ØªØ­ØªØ§Ø¬ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ²Ø§Ù…Ùƒ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„';
      }

      updateChallengeProgress();
    }

    // Analytics: subject analysis + monthly progress + chart
    function renderSubjectAnalysis() {
      const container = document.getElementById('subjectAnalysis');
      container.innerHTML = '';
      subjects.forEach(s => {
        const studyHours = s.studyLog.reduce((sum, log) => sum + (log.minutes / 60), 0).toFixed(1);
        const level = s.progress >= 80 ? 'Ù…Ù…ØªØ§Ø²' : s.progress >= 60 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
        const color = s.progress >= 80 ? 'text-green-600' : s.progress >= 60 ? 'text-yellow-600' : 'text-red-600';
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
        row.innerHTML = `
          <div class="flex items-center space-x-3 space-x-reverse">
            <span class="text-2xl">${s.icon}</span>
            <div>
              <h4 class="font-bold text-gray-800">${s.name}</h4>
              <p class="text-sm text-gray-600">${studyHours} Ø³Ø§Ø¹Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</p>
            </div>
          </div>
          <div class="text-left">
            <div class="text-lg font-bold ${color}">${level}</div>
            <div class="text-sm text-gray-600">${s.progress}% Ù…ÙƒØªÙ…Ù„</div>
          </div>`;
        container.appendChild(row);
      });
    }

    function getMonthlyStudyHours() {
      const monthlyHours = {};
      const today = new Date();
      const startOfTodayMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const week = 1;
      let weeklyData = 0;
      
      studyLog.forEach(log => {
          const logDate = new Date(log.date);
          const day = logDate.getDay();
          const weekOfMonth = Math.ceil(logDate.getDate() / 7);

          if(logDate >= startOfTodayMonth) {
              if(!monthlyHours[`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekOfMonth}`]) {
                  monthlyHours[`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekOfMonth}`] = 0;
              }
              monthlyHours[`Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekOfMonth}`] += log.minutes / 60;
          }
      });
      return monthlyHours;
    }

    function renderMonthlyProgress() {
      const container = document.getElementById('monthlyProgress');
      container.innerHTML = '';
      const monthData = getMonthlyStudyHours();
      const weeks = ['Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø¹'];
      const max = Math.max(...Object.values(monthData), 1);
      
      weeks.forEach(week => {
        const h = monthData[week] || 0;
        const percentage = (h / max) * 100;
        const color = h >= 30 ? 'bg-green-500' : h >= 25 ? 'bg-yellow-500' : 'bg-red-500';
        const weekDiv = document.createElement('div');
        weekDiv.className = 'text-center';
        weekDiv.innerHTML = `<div class="${color} rounded-lg mb-2 flex items-end justify-center text-white font-bold" style="height:${Math.max(percentage, 20)}px;"><span class="text-sm mb-1">${h.toFixed(1)}Ø³</span></div>`;
        container.appendChild(weekDiv);
      });
    }

    function initializeWeeklyChart() {
      const canvas = document.getElementById('weeklyChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (weeklyChart) weeklyChart.destroy();
      const data = getWeeklyStudyHours();
      const chartData = DAYS.map(day => data[day] || 0);

      weeklyChart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: DAYS, 
          datasets: [{ 
            label: 'Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³Ø©', 
            data: chartData, 
            borderColor:'rgb(99,102,241)', 
            backgroundColor:'rgba(99,102,241,.1)', 
            borderWidth:3, 
            fill:true, 
            tension:.4 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins:{ 
            legend:{ display: false } 
          }, 
          scales:{ 
            y:{ 
              beginAtZero: true, 
              ticks:{ stepSize:2 } 
            } 
          } 
        }
      });
    }

    function renderStudyPatterns() {
        const container = document.getElementById('studyPatterns');
        container.innerHTML = '';
        if (studyLog.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø·. Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©!</div>`;
            return;
        }

        const studyHoursByTime = { 'Ø§Ù„ØµØ¨Ø§Ø­': 0, 'Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±': 0, 'Ø§Ù„Ù…Ø³Ø§Ø¡': 0 };
        const studyHoursByDay = {};
        let totalSessions = 0;
        let totalSessionMinutes = 0;
        
        studyLog.forEach(log => {
            const date = new Date(log.date);
            const hour = date.getHours();
            const day = DAYS[date.getDay()];
            
            if (hour >= 9 && hour < 12) studyHoursByTime['Ø§Ù„ØµØ¨Ø§Ø­'] += log.minutes / 60;
            else if (hour >= 14 && hour < 17) studyHoursByTime['Ø¨Ø¹Ø¯ Ø§Ù„Ø¸Ù‡Ø±'] += log.minutes / 60;
            else if (hour >= 19 && hour < 22) studyHoursByTime['Ø§Ù„Ù…Ø³Ø§Ø¡'] += log.minutes / 60;

            studyHoursByDay[day] = (studyHoursByDay[day] || 0) + (log.minutes / 60);

            totalSessions++;
            totalSessionMinutes += log.minutes;
        });

        const bestTime = Object.keys(studyHoursByTime).reduce((a, b) => studyHoursByTime[a] > studyHoursByTime[b] ? a : b);
        const mostProductiveDay = Object.keys(studyHoursByDay).reduce((a, b) => studyHoursByDay[a] > studyHoursByDay[b] ? a : b);
        const avgSessionDuration = totalSessions > 0 ? (totalSessionMinutes / totalSessions).toFixed(0) : 0;

        container.innerHTML = `
            <div class="flex justify-between items-center"><span class="text-gray-700">Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ù„Ø¯Ø±Ø§Ø³Ø©</span><span class="font-bold text-blue-600">${bestTime}</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-700">Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</span><span class="font-bold text-green-600">${avgSessionDuration} Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-700">Ø£ÙƒØ«Ø± Ø§Ù„Ø£ÙŠØ§Ù… Ø¥Ù†ØªØ§Ø¬ÙŠØ©</span><span class="font-bold text-purple-600">${mostProductiveDay}</span></div>
        `;
    }

    function renderRecentAchievements() {
        const container = document.getElementById('recentAchievements');
        container.innerHTML = '';
        const recentEarned = achievements.filter(a => a.earned).slice(-3); // Show last 3 earned
        if (recentEarned.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…ÙƒØªØ³Ø¨Ø© Ø¨Ø¹Ø¯.</div>`;
            return;
        }

        recentEarned.forEach(a => {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-3 space-x-reverse p-3 bg-blue-50 rounded-lg';
            div.innerHTML = `<span class="text-2xl">${a.icon}</span><div><p class="font-semibold text-gray-800">${a.name}</p><p class="text-sm text-gray-600">${a.description}</p></div>`;
            container.appendChild(div);
        });
    }

    // ===== Timer =====
    function setTimerMode(mode, el) {
      timer.mode = mode;
      timer.minutes = mode==='focus' ? 25 : mode==='break' ? 5 : 15;
      timer.seconds = 0;
      document.querySelectorAll('.timer-mode').forEach(b=>b.classList.remove('active'));
      if (el) el.classList.add('active');
      updateTimerDisplay();
    }
    function startTimer() {
      if (timer.isRunning) return;
      timer.isRunning = true;
      timer.interval = setInterval(()=>{
        if (timer.minutes === 0 && timer.seconds === 0) {
            clearInterval(timer.interval);
            timer.isRunning = false;
            showNotification('ğŸ‰ Ø£Ø­Ø³Ù†Øª! Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©.', 'success');
            if (currentStudyingSubject && timer.mode === 'focus') {
                const subj = subjects.find(s => s.id === currentStudyingSubject);
                if (subj) {
                    const minutesCompleted = 25; // Pomodoro session length
                    subj.progress = Math.min(100, subj.progress + 5); 
                    subj.isStudying = false; 
                    studyLog.push({ date: new Date().toISOString(), minutes: minutesCompleted, subjectId: subj.id });
                    points += 10; // Award points for completing a session
                    checkAchievements();
                    checkDailyChallengeCompletion();
                    renderSubjects(); 
                    saveToLocalStorage();
                    updateDashboardStats();
                    updateChallengeProgress();
                }
                currentStudyingSubject = null;
            }
            resetTimer();
            return;
        }
        if (timer.seconds===0){
          timer.minutes--; timer.seconds=59;
        } else timer.seconds--;
        updateTimerDisplay();
      }, 1000);
    }
    function pauseTimer(){ if (!timer.isRunning) return; clearInterval(timer.interval); timer.isRunning=false; }
    function resetTimer(){ clearInterval(timer.interval); timer.isRunning=false; timer.seconds=0; timer.minutes = timer.mode==='focus'?25:timer.mode==='break'?5:15; updateTimerDisplay(); }
    function updateTimerDisplay(){ document.getElementById('timerDisplay').textContent = `${String(timer.minutes).padStart(2,'0')}:${String(timer.seconds).padStart(2,'0')}`; }

    function startStudySession(subjectId) {
      subjects.forEach(s=>s.isStudying=false);
      const s = subjects.find(x=>x.id===subjectId); if (!s) return;
      s.isStudying = true; currentStudyingSubject = s.id; renderSubjects();
      showNotification(`ğŸ¯ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©: ${s.name}. Ù†ØµÙŠØ­Ø©: Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø© ÙƒÙ„ 25 Ø¯Ù‚ÙŠÙ‚Ø©.`, 'info');
      setTimerMode('focus', document.querySelector('.timer-mode')); startTimer();
    }

    function checkAchievements() {
        achievements.forEach(a => {
            if (!a.earned && a.condition({ subjects, studyLog })) {
                a.earned = true;
                showNotification(`ğŸŒŸ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø­Ù‚Ù‚Øª Ø¥Ù†Ø¬Ø§Ø² "${a.name}"!`, 'success');
            }
        });
        renderAchievements();
        saveToLocalStorage();
    }

    // ===== Settings: Challenges =====
    function renderChallengeSubjects() {
      const container = document.getElementById('challengeSubjects');
      container.innerHTML = '';
      subjects.forEach(s=>{
        const row = document.createElement('div');
        row.className = 'flex items-center space-x-3 space-x-reverse p-2 bg-gray-50 rounded-lg';
        const checked = weeklyChallenge.subjects.includes(s.id) ? 'checked' : '';
        row.innerHTML = `
          <input type="checkbox" id="challenge_${s.id}" ${checked} class="w-4 h-4 text-blue-600" onchange="toggleChallengeSubject(${s.id})"/>
          <label for="challenge_${s.id}" class="flex items-center space-x-2 space-x-reverse cursor-pointer">
            <span class="text-xl">${s.icon}</span><span class="font-semibold">${s.name}</span><span class="text-sm text-gray-600">(${s.weeklyHours}Ø³)</span>
          </label>`;
        container.appendChild(row);
      });
    }
    function toggleChallengeSubject(id) {
      const i = weeklyChallenge.subjects.indexOf(id);
      if (i>-1) weeklyChallenge.subjects.splice(i,1); else weeklyChallenge.subjects.push(id);
      saveToLocalStorage();
    }
    function updateWeeklyGoal() {
      const goal = parseInt(document.getElementById('weeklyGoalSlider').value,10);
      weeklyChallenge.goal = goal; document.getElementById('weeklyGoalDisplay').textContent = goal;
      updateChallengeProgress(); saveToLocalStorage();
    }
    function saveWeeklyChallenge() {
      weeklyChallenge.startDate = new Date().toISOString();
      weeklyChallenge.completed = 0;
      updateChallengeProgress(); 
      saveToLocalStorage();
      showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ', 'success');
    }
    function updateChallengeProgress() {
        const today = new Date();
        const startOfWeek = new Date(weeklyChallenge.startDate);
        const daysLeft = Math.max(0, 7 - Math.floor((today - startOfWeek) / (1000 * 60 * 60 * 24)));
        weeklyChallenge.completed = studyLog.filter(log => new Date(log.date) >= startOfWeek && weeklyChallenge.subjects.includes(log.subjectId)).reduce((sum, log) => sum + (log.minutes / 60), 0).toFixed(1);
        
        const completion = weeklyChallenge.goal > 0 ? (weeklyChallenge.completed / weeklyChallenge.goal) * 100 : 0;

        document.getElementById('challengeProgress').textContent = `${weeklyChallenge.completed}/${weeklyChallenge.goal}`;
        document.getElementById('challengeDaysLeft').textContent = daysLeft;
        document.getElementById('challengeCompletion').textContent = `${completion.toFixed(0)}%`;
        document.getElementById('challengeProgressBar').style.width = `${completion}%`;
    }

    // ===== Settings: Schedule (auto + manual) =====
    function ensureScheduleShape() {
      if (!weeklyChallenge.schedule || typeof weeklyChallenge.schedule!=='object') weeklyChallenge.schedule = {};
      DAYS.forEach(d=>{
        if (!weeklyChallenge.schedule[d]) weeklyChallenge.schedule[d] = {};
      });
    }

    function renderScheduleTable() {
      ensureScheduleShape();
      const table = document.getElementById('scheduleTable');
      table.innerHTML = '';
      DAYS.forEach(day=>{
        let dayHours = 0;
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        let rowHTML = `<td class="border border-gray-300 p-3 font-semibold bg-gray-50">${day}</td>`;
        PERIODS.forEach(period=>{
          const cell = weeklyChallenge.schedule[day][period];
          if (cell && cell.subjectId) {
            const subj = subjects.find(s=>s.id===cell.subjectId);
            dayHours += cell.hours || 0;
            rowHTML += `
              <td class="border border-gray-300 p-3 text-center cursor-pointer hover:bg-gray-50" onclick="openEditCellModal('${day}','${period}')">
                <div class="flex items-center justify-center space-x-2 space-x-reverse">
                  <span class="text-lg">${subj?.icon || 'ğŸ“š'}</span>
                  <span class="font-semibold">${subj?.name || 'Ù…Ø§Ø¯Ø©'}</span>
                </div>
                <div class="text-sm text-gray-600 mt-1">${cell.hours||1} Ø³Ø§Ø¹Ø© ${cell.manual ? ' â€¢ ğŸ“Œ' : ''}</div>
              </td>`;
          } else {
            rowHTML += `<td class="border border-gray-300 p-3 text-center text-gray-400 cursor-pointer hover:bg-gray-50" onclick="openEditCellModal('${day}','${period}')">â€”</td>`;
          }
        });
        rowHTML += `<td class="border border-gray-300 p-3 text-center font-bold text-blue-600">${dayHours} Ø³Ø§Ø¹Ø©</td>`;
        tr.innerHTML = rowHTML;
        table.appendChild(tr);
      });
      computeWeeklyTotals();
    }

    function computeWeeklyTotals() {
      let total = 0;
      DAYS.forEach(d=>{
        PERIODS.forEach(p=>{
          const c = weeklyChallenge.schedule[d]?.[p];
          if (c && c.hours) total += c.hours;
        });
      });
      document.getElementById('totalWeeklyHours').textContent = total;
    }

    function generateSchedule() {
      ensureScheduleShape();
      const availableSubjects = subjects.filter(s => weeklyChallenge.subjects.includes(s.id));
      if (availableSubjects.length === 0) {
        showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ§Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹.', 'warning');
        return;
      }
      
      const subjectHoursNeeded = {};
      availableSubjects.forEach(s => subjectHoursNeeded[s.id] = s.weeklyHours);

      const scheduleCopy = JSON.parse(JSON.stringify(weeklyChallenge.schedule));

      for (let i = 0; i < DAYS.length * PERIODS.length; i++) {
        const day = DAYS[i % DAYS.length];
        const period = PERIODS[Math.floor(i / DAYS.length)];
        
        if (scheduleCopy[day][period]?.manual) continue;

        const availableSlots = availableSubjects.filter(s => subjectHoursNeeded[s.id] > 0);
        if (availableSlots.length === 0) break;

        const pick = availableSlots[Math.floor(Math.random() * availableSlots.length)];
        const hours = Math.min(3, subjectHoursNeeded[pick.id], Math.floor(Math.random() * 3) + 1);
        
        if (hours > 0) {
            scheduleCopy[day][period] = { subjectId: pick.id, hours, manual: false };
            subjectHoursNeeded[pick.id] -= hours;
        } else {
            scheduleCopy[day][period] = undefined;
        }
      }

      weeklyChallenge.schedule = scheduleCopy;
      renderScheduleTable();
      saveToLocalStorage();
      showNotification('ğŸ“… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡/Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.', 'info');
    }

    // Manual edit modal
    let editContext = { day: null, period: null };
    function openEditCellModal(day=null, period=null) {
      editContext.day = day || DAYS[0];
      editContext.period = period || PERIODS[0];
      // Fill selects
      const daySel = document.getElementById('editDaySelect');
      daySel.value = editContext.day;
      const periodSel = document.getElementById('editPeriodSelect');
      periodSel.value = editContext.period;
      // Subjects dropdown
      const subjSel = document.getElementById('editSubjectSelect');
      subjSel.innerHTML = subjects.map(s=>`<option value="${s.id}">${s.icon} ${s.name}</option>`).join('');
      // Prefill hours if exists
      const cell = weeklyChallenge.schedule[editContext.day]?.[editContext.period];
      document.getElementById('editHoursInput').value = cell?.hours || 1;
      if (cell?.subjectId) subjSel.value = cell.subjectId;
      document.getElementById('editCellModal').classList.remove('hidden');
      document.getElementById('editCellModal').classList.add('flex');
    }
    function closeEditCellModal() {
      document.getElementById('editCellModal').classList.add('hidden');
      document.getElementById('editCellModal').classList.remove('flex');
    }
    function saveCellEdit() {
      const day = document.getElementById('editDaySelect').value;
      const period = document.getElementById('editPeriodSelect').value;
      const subjectId = parseInt(document.getElementById('editSubjectSelect').value,10);
      const hours = Math.min(3, Math.max(1, parseInt(document.getElementById('editHoursInput').value,10) || 1));
      if (!weeklyChallenge.schedule[day]) weeklyChallenge.schedule[day] = {};
      weeklyChallenge.schedule[day][period] = { subjectId, hours, manual: true };
      renderScheduleTable();
      saveToLocalStorage();
      showNotification('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©', 'success');
      closeEditCellModal();
    }
    function removeCell() {
      const day = document.getElementById('editDaySelect').value;
      const period = document.getElementById('editPeriodSelect').value;
      if (weeklyChallenge.schedule[day]) delete weeklyChallenge.schedule[day][period];
      renderScheduleTable();
      saveToLocalStorage();
      showNotification('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø©', 'warning');
      closeEditCellModal();
    }

    // Add Subject Modal
    function openAddSubject(){ document.getElementById('addSubjectModal').classList.remove('hidden'); document.getElementById('addSubjectModal').classList.add('flex'); }
    function closeAddSubject(){ document.getElementById('addSubjectModal').classList.add('hidden'); document.getElementById('addSubjectModal').classList.remove('flex'); }
    function updateHoursDisplay(){ document.getElementById('hoursDisplay').textContent = document.getElementById('weeklyHoursSlider').value; }
    function updateHoursRecommendation(){
      const d = document.getElementById('difficulty').value;
      const map = { easy:'Ø§Ù„ØªÙˆØµÙŠØ©: 2-4 Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø³Ù‡Ù„Ø©', medium:'Ø§Ù„ØªÙˆØµÙŠØ©: 4-6 Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø©', hard:'Ø§Ù„ØªÙˆØµÙŠØ©: 6-10 Ø³Ø§Ø¹Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØµØ¹Ø¨Ø©' };
      document.getElementById('hoursRecommendation').textContent = map[d];
    }
    function saveSubject(){
      const name = document.getElementById('subjectName').value.trim();
      const weeklyHours = parseInt(document.getElementById('weeklyHoursSlider').value,10);
      const difficulty = document.getElementById('difficulty').value;
      if (!name) { showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', 'error'); return; }
      const icons = ['ğŸ“š','ğŸ”¬','ğŸ¨','ğŸŒ','ğŸ’»','ğŸµ','âš½','ğŸ§®','ğŸ§ ','ğŸ—ºï¸'];
      const colors = ['blue','purple','green','orange','red','teal'];
      const id = subjects.length ? Math.max(...subjects.map(s=>s.id))+1 : 1;
      subjects.push({ id, name, icon: icons[Math.floor(Math.random()*icons.length)], weeklyHours, progress:0, difficulty, color: colors[Math.floor(Math.random()*colors.length)], isStudying:false, studyLog: [] });
      renderSubjects();
      renderChallengeSubjects();
      saveToLocalStorage();
      closeAddSubject();
      showNotification(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© "${name}"`, 'success');
    }

    // Custom Confirmation Modal
    function setupConfirmModal() {
      const confirmYesBtn = document.getElementById('confirmYesBtn');
      const confirmNoBtn = document.getElementById('confirmNoBtn');
      const confirmModal = document.getElementById('confirmModal');

      confirmYesBtn.addEventListener('click', () => {
        if (confirmCallback) {
          confirmCallback();
          confirmCallback = null;
        }
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
      });
      confirmNoBtn.addEventListener('click', () => {
        confirmCallback = null;
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
      });
    }

    function showConfirmModal(action) {
      document.getElementById('confirmModal').classList.remove('hidden');
      document.getElementById('confirmModal').classList.add('flex');

      if (action === 'resetData') {
        document.getElementById('confirmTitle').textContent = 'ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        document.getElementById('confirmMessage').textContent = 'âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.';
        confirmCallback = resetData;
      } else if (action === 'resetStats') {
        document.getElementById('confirmTitle').textContent = 'ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª';
        document.getElementById('confirmMessage').textContent = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø¯Ù… ÙÙ‚Ø·ØŸ';
        confirmCallback = resetStatsOnly;
      }
    }

    // Data management
    function resetData() {
      subjects = [];
      achievements = achievements.map(a=>({...a, earned:false}));
      weeklyChallenge = { goal:25, completed:0, subjects:[], startDate:new Date().toISOString(), schedule:{} };
      studyLog = [];
      points = 0;
      currentStudyingSubject = null;
      renderDashboard(); renderAnalytics(); renderSettings();
      saveToLocalStorage();
      showNotification('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
    }
    
    function resetStatsOnly() {
      subjects.forEach(s=>{ s.progress=0; s.isStudying=false; s.studyLog = []; });
      weeklyChallenge.completed = 0;
      studyLog = [];
      points = 0;
      renderDashboard(); renderAnalytics(); updateChallengeProgress();
      saveToLocalStorage();
      showNotification('ğŸ“Š ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'success');
    }

    // Notifications
    function showNotification(message, type='info', duration=3500) {
      const container = document.getElementById('notificationContainer');
      const el = document.createElement('div');
      const colors = { success:'bg-green-100 text-green-800 border-green-300', error:'bg-red-100 text-red-800 border-red-300', warning:'bg-yellow-100 text-yellow-800 border-yellow-300', info:'bg-blue-100 text-blue-800 border-blue-300' };
      el.className = `floating-notification border rounded-xl px-4 py-3 shadow-lg ${colors[type]||colors.info} whitespace-pre-line`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(20px)'; setTimeout(()=> el.remove(), 300); }, duration);
    }

    // Local Storage
    function saveToLocalStorage(){
      const data = { subjects, achievements, weeklyChallenge, studyLog, points, dailyChallenge };
      localStorage.setItem('studyBuddyMerged', JSON.stringify(data));
    }
    function loadFromLocalStorage(){
      try{
        const raw = localStorage.getItem('studyBuddyMerged');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data.subjects)) subjects = data.subjects;
        if (Array.isArray(data.achievements)) achievements = data.achievements;
        if (data.weeklyChallenge) weeklyChallenge = data.weeklyChallenge;
        if (Array.isArray(data.studyLog)) studyLog = data.studyLog;
        if (data.points !== undefined) points = data.points;
        if (data.dailyChallenge) dailyChallenge = data.dailyChallenge;
        checkAchievements();
      } catch(e){ console.error("Error loading from local storage:", e); }
    }
  </script>
</body>
</html>
