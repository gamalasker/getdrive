<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ÙƒÙ†Ø² Ø§Ù„ØªØµØ±ÙŠÙ - Le TrÃ©sor des Verbes</title>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Fredoka+One:wght@400&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ========= Base ========= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root{
            --bg1:#2c1810; --bg2:#8b4513; --gold:#daa520; --gold2:#b8860b;
            --green:#32cd32; --green2:#228b22; --brown:#8b4513; --brown2:#654321;
            --paper:#f4e4bc; --white:#fff; --text:#2d2d2d; --muted:#666;
            --warn:#ff4444; --ok:#28a745; --accent1:#ff6b35; --accent2:#f7931e;
            --royal:#2356c5;
        }
        html,body{ min-height:100%; }
        body{
            font-family:'Amiri', serif;
            background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--gold));
            color: var(--text);
            overflow-x:hidden;
        }
        .game-container{ max-width:1200px; margin:0 auto; padding:20px; position:relative; }

        /* ========= Header ========= */
        .header{ text-align:center; margin-bottom: 18px; color:#fff; }
        .game-title{
            font-family:'Fredoka One', cursive;
            font-size: 2.6rem; letter-spacing:.5px;
            text-shadow:3px 3px 6px rgba(0,0,0,.5);
            margin-bottom:8px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        }
        .subtitle{ font-size: 1.1rem; opacity:.9; }

        /* ========= Map / Cards ========= */
        .treasure-map{
            background: var(--paper);
            border: 8px solid var(--brown);
            border-radius: 20px;
            padding: 22px;
            margin: 16px auto;
            max-width: 900px;
            position:relative;
            box-shadow: inset 0 0 50px rgba(139, 69, 19, .25), 0 10px 30px rgba(0,0,0,.25);
        }
        .map-title{
            text-align:center;
            font-family:'Fredoka One', cursive;
            font-size:1.6rem; color:var(--brown);
            margin-bottom:18px;
        }
        .progress-bar{ width:100%; height: 18px; background: var(--brown); border-radius: 9px; overflow:hidden; }
        .progress-fill{
            height:100%; background: linear-gradient(90deg, var(--green), var(--green2));
            width:0%; transition:width .6s ease; border-radius: 9px;
        }
        .progress-text{ text-align:center; color:var(--brown); font-weight:bold; margin:10px 0 16px; }

        .map-grid{ display:grid; grid-template-columns: repeat(3,1fr); gap:16px; }
        .map-piece{
            aspect-ratio:1;
            background: linear-gradient(135deg, var(--gold), var(--gold2));
            border:3px solid var(--brown);
            border-radius:14px;
            display:flex; flex-direction:column; align-items:center; justify-content:center;
            cursor:pointer; transition:transform .2s ease, box-shadow .2s ease;
            position:relative; overflow:hidden; padding:8px; text-align:center;
        }
        .map-piece:hover{ transform:scale(1.035); box-shadow:0 8px 25px rgba(0,0,0,.28); }
        .map-piece.completed{ background:linear-gradient(135deg, var(--green), var(--green2)); animation:glow 2s infinite alternate; }
        @keyframes glow{ from{ box-shadow:0 0 16px var(--green);} to{ box-shadow: 0 0 30px var(--green), 0 0 46px var(--green);} }
        .piece-number{ font-size:1.8rem; font-weight:700; color:#fff; text-shadow:2px 2px 4px rgba(0,0,0,.5); }
        .piece-title{ font-size:.95rem; color:#fff; margin-top:4px; font-weight:700; }
        .piece-subtitle{ font-size:.78rem; color:#f0f0f0; margin-top:2px; }
        .piece-score { position: absolute; bottom: 8px; left: 8px; font-size: 0.8rem; color: #fff; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 6px; }
        .lock-icon{ position:absolute; top:8px; right:8px; font-size:1.1rem; color:var(--brown); }

        .start-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 6px; }

        .btn{
            appearance:none; border:none; cursor:pointer; font-weight:700;
            border-radius: 22px; padding: 12px 22px; color:#fff;
            background:linear-gradient(45deg, var(--accent1), var(--accent2));
            box-shadow:0 6px 18px rgba(0,0,0,.25);
            transition: transform .18s ease, box-shadow .18s ease, background .3s ease;
        }
        .btn:hover{ transform: translateY(-2px); box-shadow:0 10px 22px rgba(0,0,0,.35); }
        .btn.secondary{ background:linear-gradient(45deg, #555, #777); }
        .btn.ghost{
            background:transparent; border:2px solid var(--brown);
            color:var(--brown); box-shadow:none;
        }
        .btn.small{ padding: 8px 14px; border-radius: 16px; font-size:.9rem; }

        /* ========= Game Screen ========= */
        .game-screen{
            display:none; background:var(--paper); border:8px solid var(--brown); border-radius:20px;
            padding: 18px; margin: 18px auto; max-width: 900px; box-shadow:0 10px 30px rgba(0,0,0,.25);
        }

        .topbar{
            display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:10px;
        }
        .stats{
            display:flex; align-items:center; gap:8px; flex-wrap:wrap;
            color:var(--brown); font-weight:700;
        }
        .badge{
            background:#fff; border:2px solid var(--brown); color:var(--brown);
            padding:6px 10px; border-radius:14px; font-size:.95rem; display:flex; align-items:center; gap:6px;
        }
        .timer{
            display:flex; flex-direction:column; gap:6px; min-width:220px;
        }
        .timer-label{ color:var(--brown); font-weight:700; font-size:.95rem; }
        .timer-bar{ height: 10px; background:#e6d7aa; border-radius: 6px; overflow:hidden; border:1px solid #d3be83; }
        .timer-fill{ height:100%; width: 100%; background: linear-gradient(90deg, #12c2e9, #c471ed, #f64f59); transition: width .2s linear; }

        .question-container{ text-align:center; margin:6px 0 16px; }
        .question-title{ font-size:1.45rem; color:var(--brown); margin-bottom: 8px; }
        .question-verb{ font-size: 1.9rem; color:var(--gold2); margin: 8px 0 4px; font-weight:700; }
        .question-meta{ font-size:.98rem; color:var(--muted); }

        .options-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:14px; margin:16px 0; }
        .verb-card{
            background:#fff; padding:16px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,.08);
            border:3px solid transparent; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
            text-align:center; user-select:none; outline:none;
        }
        .verb-card:hover{ transform:translateY(-3px); box-shadow:0 8px 22px rgba(0,0,0,.16); }
        .verb-card.correct{ border-color:var(--ok); background:#ecffef; animation:correctPulse .5s ease; }
        .verb-card.incorrect{ border-color:var(--warn); background:#ffe7e7; animation:shake .45s ease; }
        @keyframes correctPulse{ 0%{ transform:scale(1);} 50%{ transform:scale(1.035);} 100%{ transform:scale(1);} }
        @keyframes shake{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-8px);} 75%{ transform:translateX(8px);} }

        .treasure-reveal{ text-align:center; margin: 12px 0; display:none; }
        .treasure-box{
            width: 200px; height: 140px; margin: 0 auto 6px;
            background:linear-gradient(45deg, var(--gold), var(--gold2));
            border:4px solid var(--brown); border-radius:14px; display:flex; align-items:center; justify-content:center;
            font-size:2.6rem; animation:treasureGlow 2s infinite alternate;
        }
        @keyframes treasureGlow{ from{ box-shadow:0 0 18px var(--gold);} to{ box-shadow:0 0 34px var(--gold), 0 0 50px var(--gold);} }

        .toolbar{ display:flex; gap:10px; justify-content:center; margin-top: 12px; flex-wrap:wrap; }

        /* ========= Floating helper ========= */
        .frenchapeau{
            position:fixed; bottom: 20px; right: 20px; width: 110px; height: 110px;
            background: var(--brown); color:#fff; border-radius:50%;
            display:flex; align-items:center; justify-content:center; font-size:2.4rem;
            box-shadow:0 8px 22px rgba(0,0,0,.32); cursor:pointer; transition:transform .2s ease; z-index: 1000;
        }
        .frenchapeau:hover{ transform: scale(1.06) rotate(8deg); }
        .hat{ position:absolute; top:-18px; font-size:1.9rem; animation:bounce 2s infinite; }
        @keyframes bounce{ 0%,20%,50%,80%,100%{ transform:translateY(0);} 40%{ transform:translateY(-10px);} 60%{ transform:translateY(-5px);} }
        .speech-bubble{
            position:absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            background:#fff; color:#333; padding: 12px 14px; border-radius: 14px;
            box-shadow:0 4px 15px rgba(0,0,0,.2); max-width: 270px; font-size:.95rem; display:none; animation:fadeIn .45s ease;
        }
        .speech-bubble::after{
            content:''; position:absolute; bottom:-10px; left: 50%; transform: translateX(-50%);
            width:0; height:0;
            border-left:10px solid transparent; border-right:10px solid transparent; border-top:10px solid #fff;
        }
        @keyframes fadeIn{ from{ opacity:0; transform:translateY(10px);} to{ opacity:1; transform:translateY(0);} }

        /* ========= Celebration ========= */
        .celebration{ position:fixed; inset:0; pointer-events:none; z-index:1100; }
        .confetti{ position:absolute; width:10px; height:10px; background:#ffd700; animation: confettiFall 3s linear forwards; }
        @keyframes confettiFall{ to{ transform: translateY(100vh) rotate(360deg); opacity:0; } }

        /* ========= Modal (replaces alert) ========= */
        .modal{
            position: fixed; inset:0; background: rgba(0,0,0,.45);
            display:none; align-items:center; justify-content:center; z-index:1200; padding:18px;
        }
        .modal-card{
            width:min(560px, 92vw); background:#fff; border-radius:16px; padding:18px;
            box-shadow:0 12px 28px rgba(0,0,0,.35);
        }
        .modal-title{ font-weight:800; font-size:1.2rem; color:var(--brown); margin-bottom:8px; }
        .modal-body{ color:#333; font-size:1rem; line-height:1.7; white-space: pre-wrap; }
        .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }

        /* ========= Responsive ========= */
        @media (max-width: 850px){
            .map-grid{ grid-template-columns: repeat(2,1fr); }
        }
        @media (max-width: 560px){
            .game-title{ font-size:2rem; }
            .frenchapeau{ width:84px; height:84px; font-size:1.8rem; }
        }
    </style>
</head>
<body>
    <div class="game-container" aria-live="polite">
        <div class="header" role="banner">
            <h1 class="game-title">ğŸ° ÙƒÙ†Ø² Ø§Ù„ØªØµØ±ÙŠÙ</h1>
            <p class="subtitle">Le TrÃ©sor des Verbes</p>
        </div>

        <!-- Map -->
        <section id="mainMap" class="treasure-map" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„">
            <h2 class="map-title">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© - La Carte Ancienne</h2>
            <div class="progress-bar" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Ø§Ù„ØªÙ‚Ø¯Ù…: 0/6 Ù…Ø±Ø§Ø­Ù„ Ù…ÙƒØªÙ…Ù„Ø©</div>
            <div class="map-grid" id="mapGrid">
                <div class="map-piece" data-level="1" tabindex="0" role="button" aria-label="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰">
                    <div class="piece-number">1</div>
                    <div class="piece-title">Ù„ØºØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
                    <div class="piece-subtitle">Le MystÃ¨re des Groupes</div>
                    <div class="lock-icon">ğŸ”“</div>
                    <div class="piece-score" id="score-1" hidden></div>
                </div>
                <div class="map-piece" data-level="2" tabindex="0" role="button" aria-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©">
                    <div class="piece-number">2</div>
                    <div class="piece-title">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</div>
                    <div class="piece-subtitle">Premier Groupe</div>
                    <div class="lock-icon">ğŸ”’</div>
                    <div class="piece-score" id="score-2" hidden></div>
                </div>
                <div class="map-piece" data-level="3" tabindex="0" role="button" aria-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©">
                    <div class="piece-number">3</div>
                    <div class="piece-title">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</div>
                    <div class="piece-subtitle">DeuxiÃ¨me Groupe</div>
                    <div class="lock-icon">ğŸ”’</div>
                    <div class="piece-score" id="score-3" hidden></div>
                </div>
                <div class="map-piece" data-level="4" tabindex="0" role="button" aria-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©">
                    <div class="piece-number">4</div>
                    <div class="piece-title">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</div>
                    <div class="piece-subtitle">TroisiÃ¨me Groupe</div>
                    <div class="lock-icon">ğŸ”’</div>
                    <div class="piece-score" id="score-4" hidden></div>
                </div>
                <div class="map-piece" data-level="5" tabindex="0" role="button" aria-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø§Ù…Ø³Ø©">
                    <div class="piece-number">5</div>
                    <div class="piece-title">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</div>
                    <div class="piece-subtitle">Le Grand Test</div>
                    <div class="lock-icon">ğŸ”’</div>
                    <div class="piece-score" id="score-5" hidden></div>
                </div>
                <div class="map-piece" data-level="6" tabindex="0" role="button" aria-label="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¯Ø³Ø©">
                    <div class="piece-number">ğŸ‘‘</div>
                    <div class="piece-title">Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</div>
                    <div class="piece-subtitle">Le TrÃ©sor Final</div>
                    <div class="lock-icon">ğŸ”’</div>
                    <div class="piece-score" id="score-6" hidden></div>
                </div>
            </div>
            <div class="start-actions">
                <button class="btn" id="startAdventureBtn">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø©</button>
                <button class="btn ghost" id="howToBtn" aria-haspopup="dialog">â“ ÙƒÙŠÙ Ø£Ù„Ø¹Ø¨ØŸ</button>
                <button class="btn secondary small" id="resetBtn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙ‚Ø¯Ù…">â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
            </div>
        </section>

        <!-- Game Screen -->
        <section id="gameScreen" class="game-screen" aria-label="Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø¹Ø¨" hidden>
            <div class="topbar">
                <div class="stats">
                    <button class="btn ghost small" id="backBtn" aria-label="Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
                    <span class="badge" id="levelBadge">ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: 1</span>
                    <span class="badge" id="qBadge">â“ Ø§Ù„Ø³Ø¤Ø§Ù„: 1/5</span>
                    <span class="badge" id="scoreBadge">â­ Ø§Ù„Ù†Ù‚Ø§Ø·: 0</span>
                </div>
                <div class="timer" aria-label="Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ">
                    <span class="timer-label" id="timerLabel">â³ Ø§Ù„ÙˆÙ‚Øª: 20 Ø«</span>
                    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
                </div>
            </div>
            <div class="question-container">
                <h3 class="question-title" id="questionTitle"></h3>
                <div class="question-verb" id="questionVerb"></div>
                <div class="question-meta" id="questionMeta"></div>
            </div>
            <div id="optionsContainer" class="options-grid" role="listbox" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"></div>
            <div class="treasure-reveal" id="treasureReveal">
                <div class="treasure-box" aria-hidden="true">ğŸ’</div>
                <p>Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ ÙƒØ´ÙØª Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„ÙƒÙ†Ø²!</p>
            </div>
            <div class="toolbar">
                <button id="nextButton" class="btn" style="display:none;">Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button>
                <button id="tipButton" class="btn ghost">ğŸ’¡ ØªÙ„Ù…ÙŠØ­</button>
            </div>
        </section>

        <!-- Floating helper -->
        <div class="frenchapeau" id="helperBtn" aria-haspopup="true" aria-controls="speechBubble" aria-label="Frenchapeau">
            <div class="hat">ğŸ©</div>
            ğŸ‘¨â€ğŸ«
            <div class="speech-bubble" id="speechBubble">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ FrenchapeauØŒ Ù…Ø±Ø´Ø¯Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§ÙƒØªØ´Ø§Ù ÙƒÙ†Ø² Ø§Ù„ØªØµØ±ÙŠÙ!</div>
        </div>

        <!-- Celebration layer -->
        <div class="celebration" id="celebration" aria-hidden="true"></div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <div class="modal-title" id="modalTitle">Ù…Ø¹Ù„ÙˆÙ…Ø©</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-actions">
                <button class="btn ghost" id="modalClose">Ø­Ø³Ù†Ø§Ù‹</button>
            </div>
        </div>
    </div>

    <script>
        /* =======================
          State and Global Variables
        ======================== */
        const STORAGE_KEY = 'verbTreasureProgress.v1';
        const QUESTION_TIME = 20; // seconds per question

        let currentLevel = 1;
        let currentQuestion = 0;
        let score = 0;
        let completedLevels = 0;
        let bestScores = {};
        let currentQuestionData = {};

        let timerId = null;
        let timeLeft = QUESTION_TIME;
        let speechVisible = false;

        /* =======================
          Verb Database
          (Conjugations reviewed and corrected)
        ======================== */
        const verbDatabase = {
            group1: [
                { verb: "parler", conjugations: { je: "parle", tu: "parles", il: "parle", nous: "parlons", vous: "parlez", ils: "parlent" } },
  { verb: "jouer", conjugations: { je: "joue", tu: "joues", il: "joue", nous: "jouons", vous: "jouez", ils: "jouent" } },
  { verb: "Ã©tudier", conjugations: { je: "Ã©tudie", tu: "Ã©tudies", il: "Ã©tudie", nous: "Ã©tudions", vous: "Ã©tudiez", ils: "Ã©tudient" } },
  { verb: "travailler", conjugations: { je: "travaille", tu: "travailles", il: "travaille", nous: "travaillons", vous: "travaillez", ils: "travaillent" } },
  { verb: "regarder", conjugations: { je: "regarde", tu: "regardes", il: "regarde", nous: "regardons", vous: "regardez", ils: "regardent" } },
  { verb: "Ã©couter", conjugations: { je: "Ã©coute", tu: "Ã©coutes", il: "Ã©coute", nous: "Ã©coutons", vous: "Ã©coutez", ils: "Ã©coutent" } },
  { verb: "danser", conjugations: { je: "danse", tu: "danses", il: "danse", nous: "dansons", vous: "dansez", ils: "dansent" } },
  { verb: "chanter", conjugations: { je: "chante", tu: "chantes", il: "chante", nous: "chantons", vous: "chantez", ils: "chantent" } },
  { verb: "marcher", conjugations: { je: "marche", tu: "marches", il: "marche", nous: "marchons", vous: "marchez", ils: "marchent" } },
  { verb: "aimer", conjugations: { je: "aime", tu: "aimes", il: "aime", nous: "aimons", vous: "aimez", ils: "aiment" } },
  { verb: "trouver", conjugations: { je: "trouve", tu: "trouves", il: "trouve", nous: "trouvons", vous: "trouvez", ils: "trouvent" } },
  { verb: "donner", conjugations: { je: "donne", tu: "donnes", il: "donne", nous: "donnons", vous: "donnez", ils: "donnent" } },
  { verb: "demander", conjugations: { je: "demande", tu: "demandes", il: "demande", nous: "demandons", vous: "demandez", ils: "demandent" } },
  { verb: "rester", conjugations: { je: "reste", tu: "restes", il: "reste", nous: "restons", vous: "restez", ils: "restent" } },
  { verb: "arriver", conjugations: { je: "arrive", tu: "arrives", il: "arrive", nous: "arrivons", vous: "arrivez", ils: "arrivent" } },
  { verb: "tomber", conjugations: { je: "tombe", tu: "tombes", il: "tombe", nous: "tombons", vous: "tombez", ils: "tombent" } },
  { verb: "entrer", conjugations: { je: "entre", tu: "entres", il: "entre", nous: "entrons", vous: "entrez", ils: "entrent" } },
  { verb: "jouer", conjugations: { je: "joue", tu: "joues", il: "joue", nous: "jouons", vous: "jouez", ils: "jouent" } },
  { verb: "porter", conjugations: { je: "porte", tu: "portes", il: "porte", nous: "portons", vous: "portez", ils: "portent" } },
  { verb: "fermer", conjugations: { je: "ferme", tu: "fermes", il: "ferme", nous: "fermons", vous: "fermez", ils: "ferment" } },
  { verb: "garder", conjugations: { je: "garde", tu: "gardes", il: "garde", nous: "gardons", vous: "gardez", ils: "gardent" } },
  { verb: "montrer", conjugations: { je: "montre", tu: "montres", il: "montre", nous: "montrons", vous: "montrez", ils: "montrent" } },
  { verb: "manger", conjugations: { je: "mange", tu: "manges", il: "mange", nous: "mangeons", vous: "mangez", ils: "mangent" } },
  { verb: "nager", conjugations: { je: "nage", tu: "nages", il: "nage", nous: "nageons", vous: "nagez", ils: "nagent" } },
  { verb: "voyager", conjugations: { je: "voyage", tu: "voyages", il: "voyage", nous: "voyageons", vous: "voyagez", ils: "voyagent" } },
  { verb: "commencer", conjugations: { je: "commence", tu: "commences", il: "commence", nous: "commenÃ§ons", vous: "commencez", ils: "commencent" } },
  { verb: "placer", conjugations: { je: "place", tu: "places", il: "place", nous: "plaÃ§ons", vous: "placez", ils: "placent" } },
  { verb: "lancer", conjugations: { je: "lance", tu: "lances", il: "lance", nous: "lanÃ§ons", vous: "lancez", ils: "lancent" } },
  { verb: "acheter", conjugations: { je: "achÃ¨te", tu: "achÃ¨tes", il: "achÃ¨te", nous: "achetons", vous: "achetez", ils: "achÃ¨tent" } },
  { verb: "lever", conjugations: { je: "lÃ¨ve", tu: "lÃ¨ves", il: "lÃ¨ve", nous: "levons", vous: "levez", ils: "lÃ¨vent" } },
  { verb: "espÃ©rer", conjugations: { je: "espÃ¨re", tu: "espÃ¨res", il: "espÃ¨re", nous: "espÃ©rons", vous: "espÃ©rez", ils: "espÃ¨rent" } },
  { verb: "prÃ©fÃ©rer", conjugations: { je: "prÃ©fÃ¨re", tu: "prÃ©fÃ¨res", il: "prÃ©fÃ¨re", nous: "prÃ©fÃ©rons", vous: "prÃ©fÃ©rez", ils: "prÃ©fÃ¨rent" } },
  { verb: "appeler", conjugations: { je: "appelle", tu: "appelles", il: "appelle", nous: "appelons", vous: "appelez", ils: "appellent" } },
  { verb: "jeter", conjugations: { je: "jette", tu: "jettes", il: "jette", nous: "jetons", vous: "jetez", ils: "jettent" } },
  { verb: "payer", conjugations: { je: "paie", tu: "paies", il: "paie", nous: "payons", vous: "payez", ils: "paient" } },
  { verb: "essayer", conjugations: { je: "essaie", tu: "essaies", il: "essaie", nous: "essayons", vous: "essayez", ils: "essaient" } },
  { verb: "envoyer", conjugations: { je: "envoie", tu: "envoies", il: "envoie", nous: "envoyons", vous: "envoyez", ils: "envoient" } },
  { verb: "nettoyer", conjugations: { je: "nettoie", tu: "nettoies", il: "nettoie", nous: "nettoyons", vous: "nettoyez", ils: "nettoient" } }
            ],
            group2: [
                { verb: "finir", conjugations: { je: "finis", tu: "finis", il: "finit", nous: "finissons", vous: "finissez", ils: "finissent" } },
                { verb: "choisir", conjugations: { je: "choisis", tu: "choisis", il: "choisit", nous: "choisissons", vous: "choisissez", ils: "choisissent" } },
                { verb: "grandir", conjugations: { je: "grandis", tu: "grandis", il: "grandit", nous: "grandissons", vous: "grandissez", ils: "grandissent" } },
                { verb: "rÃ©ussir", conjugations: { je: "rÃ©ussis", tu: "rÃ©ussis", il: "rÃ©ussit", nous: "rÃ©ussissons", vous: "rÃ©ussissez", ils: "rÃ©ussissent" } },
                { verb: "remplir", conjugations: { je: "remplis", tu: "remplis", il: "remplit", nous: "remplissons", vous: "remplissez", ils: "remplissent" } },
                { verb: "obÃ©ir", conjugations: { je: "obÃ©is", tu: "obÃ©is", il: "obÃ©it", nous: "obÃ©issons", vous: "obÃ©issez", ils: "obÃ©issent" } },
                { verb: "rÃ©flÃ©chir", conjugations: { je: "rÃ©flÃ©chis", tu: "rÃ©flÃ©chis", il: "rÃ©flÃ©chit", nous: "rÃ©flÃ©chissons", vous: "rÃ©flÃ©chissez", ils: "rÃ©flÃ©chissent" } },
                { verb: "applaudir", conjugations: { je: "applaudis", tu: "applaudis", il: "applaudit", nous: "applaudissons", vous: "applaudissez", ils: "applaudissent" } },
                { verb: "bÃ¢tir", conjugations: { je: "bÃ¢tis", tu: "bÃ¢tis", il: "bÃ¢tit", nous: "bÃ¢tissons", vous: "bÃ¢tissez", ils: "bÃ¢tissent" } },
                { verb: "punir", conjugations: { je: "punis", tu: "punis", il: "punit", nous: "punissons", vous: "punissez", ils: "punissent" } },
                { verb: "rougir", conjugations: { je: "rougis", tu: "rougis", il: "rougit", nous: "rougissons", vous: "rougissez", ils: "rougissent" } },
                { verb: "jaunir", conjugations: { je: "jaunis", tu: "jaunis", il: "jaunit", nous: "jaunissons", vous: "jaunissez", ils: "jaunissent" } }
            ],
            group3: [
                { verb: "Ãªtre", conjugations: { je: "suis", tu: "es", il: "est", nous: "sommes", vous: "Ãªtes", ils: "sont" } },
                { verb: "avoir", conjugations: { je: "ai", tu: "as", il: "a", nous: "avons", vous: "avez", ils: "ont" } },
                { verb: "faire", conjugations: { je: "fais", tu: "fais", il: "fait", nous: "faisons", vous: "faites", ils: "font" } },
                { verb: "aller", conjugations: { je: "vais", tu: "vas", il: "va", nous: "allons", vous: "allez", ils: "vont" } },
                { verb: "prendre", conjugations: { je: "prends", tu: "prends", il: "prend", nous: "prenons", vous: "prenez", ils: "prennent" } },
                { verb: "venir", conjugations: { je: "viens", tu: "viens", il: "vient", nous: "venons", vous: "venez", ils: "viennent" } },
                { verb: "voir", conjugations: { je: "vois", tu: "vois", il: "voit", nous: "voyons", vous: "voyez", ils: "voient" } },
                { verb: "savoir", conjugations: { je: "sais", tu: "sais", il: "sait", nous: "savons", vous: "savez", ils: "savent" } },
                { verb: "pouvoir", conjugations: { je: "peux", tu: "peux", il: "peut", nous: "pouvons", vous: "pouvez", ils: "peuvent" } },
                { verb: "vouloir", conjugations: { je: "veux", tu: "veux", il: "veut", nous: "voulons", vous: "voulez", ils: "veulent" } },
                { verb: "dire", conjugations: { je: "dis", tu: "dis", il: "dit", nous: "disons", vous: "dites", ils: "disent" } },
                { verb: "mettre", conjugations: { je: "mets", tu: "mets", il: "met", nous: "mettons", vous: "mettez", ils: "mettent" } },
                { verb: "boire", conjugations: { je: "bois", tu: "bois", il: "boit", nous: "buvons", vous: "buvez", ils: "boivent" } },
                { verb: "lire", conjugations: { je: "lis", tu: "lis", il: "lit", nous: "lisons", vous: "lisez", ils: "lisent" } },
                { verb: "Ã©crire", conjugations: { je: "Ã©cris", tu: "Ã©cris", il: "Ã©crit", nous: "Ã©crivons", vous: "Ã©crivez", ils: "Ã©crivent" } },
                { verb: "dormir", conjugations: { je: "dors", tu: "dors", il: "dort", nous: "dormons", vous: "dormez", ils: "dorment" } },
                { verb: "partir", conjugations: { je: "pars", tu: "pars", il: "part", nous: "partons", vous: "partez", ils: "partent" } },
				{ verb: "courir", conjugations: { je: "cours", tu: "cours", il: "court", nous: "courons", vous: "courez", ils: "courent" } },
                { verb: "mourir", conjugations: { je: "meurs", tu: "meurs", il: "meurt", nous: "mourons", vous: "mourez", ils: "meurent" } },
                { verb: "vivre", conjugations: { je: "vis", tu: "vis", il: "vit", nous: "vivons", vous: "vivez", ils: "vivent" } },
                { verb: "suivre", conjugations: { je: "suis", tu: "suis", il: "suit", nous: "suivons", vous: "suivez", ils: "suivent" } },
                { verb: "rire", conjugations: { je: "ris", tu: "ris", il: "rit", nous: "rions", vous: "riez", ils: "rient" } },
                { verb: "sourire", conjugations: { je: "souris", tu: "souris", il: "sourit", nous: "sourions", vous: "souriez", ils: "sourient" } },
  { verb: "conduire", conjugations: { je: "conduis", tu: "conduis", il: "conduit", nous: "conduisons", vous: "conduisez", ils: "conduisent" } },
  { verb: "produire", conjugations: { je: "produis", tu: "produis", il: "produit", nous: "produisons", vous: "produisez", ils: "produisent" } },
  { verb: "traduire", conjugations: { je: "traduis", tu: "traduis", il: "traduit", nous: "traduisons", vous: "traduisez", ils: "traduisent" } },
  { verb: "connaÃ®tre", conjugations: { je: "connais", tu: "connais", il: "connaÃ®t", nous: "connaissons", vous: "connaissez", ils: "connaissent" } },
  { verb: "naÃ®tre", conjugations: { je: "nais", tu: "nais", il: "naÃ®t", nous: "naissons", vous: "naissez", ils: "naissent" } },
  { verb: "craindre", conjugations: { je: "crains", tu: "crains", il: "craint", nous: "craignons", vous: "craignez", ils: "craignent" } },
  { verb: "atteindre", conjugations: { je: "atteins", tu: "atteins", il: "atteint", nous: "atteignons", vous: "atteignez", ils: "atteignent" } },
  { verb: "Ã©teindre", conjugations: { je: "Ã©teins", tu: "Ã©teins", il: "Ã©teint", nous: "Ã©teignons", vous: "Ã©teignez", ils: "Ã©teignent" } },
  { verb: "peindre", conjugations: { je: "peins", tu: "peins", il: "peint", nous: "peignons", vous: "peignez", ils: "peignent" } },
  { verb: "joindre", conjugations: { je: "joins", tu: "joins", il: "joint", nous: "joignons", vous: "joignez", ils: "joignent" } },
  { verb: "battre", conjugations: { je: "bats", tu: "bats", il: "bat", nous: "battons", vous: "battez", ils: "battent" } },
  { verb: "mettre", conjugations: { je: "mets", tu: "mets", il: "met", nous: "mettons", vous: "mettez", ils: "mettent" } },
  { verb: "rompre", conjugations: { je: "romps", tu: "romps", il: "rompt", nous: "rompons", vous: "rompez", ils: "rompent" } },
  { verb: "vaincre", conjugations: { je: "vaincs", tu: "vaincs", il: "vainc", nous: "vainquons", vous: "vainquez", ils: "vainquent" } }
]
                    };
        const pronouns = ["je", "tu", "il", "elle", "nous", "vous", "ils", "elles"];

        const levels = {
            1: { title: "Ù„ØºØ² Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª - Le MystÃ¨re des Groupes", questionCount: 8 },
            2: { title: "ØªØµØ±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Premier Groupe", questionCount: 12 },
            3: { title: "ØªØµØ±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© - DeuxiÃ¨me Groupe", questionCount: 12 },
            4: { title: "ØªØµØ±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© - TroisiÃ¨me Groupe", questionCount: 15 },
            5: { title: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ - Le Grand Test", questionCount: 20 },
            6: { title: "Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ - Le TrÃ©sor Final", questionCount: 20 }
        };

        const speeches = [
            "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ FrenchapeauØŒ Ù…Ø±Ø´Ø¯Ùƒ ÙÙŠ Ø±Ø­Ù„Ø© Ø§ÙƒØªØ´Ø§Ù ÙƒÙ†Ø² Ø§Ù„ØªØµØ±ÙŠÙ!",
            "ÙƒÙ„ ÙØ¹Ù„ ØªØµØ±ÙÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ ÙŠØ±Ù…Ù… Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©!",
            "Ø£Ù†Øª ØªÙ‚ØªØ±Ø¨ Ù…Ù† Ø§Ù„ÙƒÙ†Ø²... Ù„Ø§ ØªØ³ØªØ³Ù„Ù…!",
            "Ù…Ù…ØªØ§Ø²! Ø£Ø±Ù‰ Ø£Ù†Ùƒ ØªØªÙ‚Ù† Ø§Ù„ØªØµØ±ÙŠÙ Ø¨Ø³Ø±Ø¹Ø©!",
            "ØªØ°ÙƒØ±: Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€ -er",
            "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ØªÙ†ØªÙ‡ÙŠ Ø¨Ù€ -ir ÙˆØ§Ù„Ø«Ø§Ù„Ø«Ø© Ø£ÙØ¹Ø§Ù„ Ø´Ø§Ø°Ø©!"
        ];

        /* =======================
          UI Utilities
        ======================== */
        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const els = {
            mainMap: $("#mainMap"),
            gameScreen: $("#gameScreen"),
            progressFill: $("#progressFill"),
            progressText: $("#progressText"),
            mapGrid: $("#mapGrid"),
            startAdventureBtn: $("#startAdventureBtn"),
            howToBtn: $("#howToBtn"),
            resetBtn: $("#resetBtn"),
            backBtn: $("#backBtn"),
            questionTitle: $("#questionTitle"),
            questionVerb: $("#questionVerb"),
            questionMeta: $("#questionMeta"),
            optionsContainer: $("#optionsContainer"),
            nextButton: $("#nextButton"),
            treasureReveal: $("#treasureReveal"),
            celebration: $("#celebration"),
            helperBtn: $("#helperBtn"),
            speechBubble: $("#speechBubble"),
            timerLabel: $("#timerLabel"),
            timerFill: $("#timerFill"),
            levelBadge: $("#levelBadge"),
            qBadge: $("#qBadge"),
            scoreBadge: $("#scoreBadge"),
            tipButton: $("#tipButton"),
            modal: $("#modal"),
            modalTitle: $("#modalTitle"),
            modalBody: $("#modalBody"),
            modalClose: $("#modalClose"),
        };

        function show(el) { el.hidden = false; el.style.display = 'block'; }
        function hide(el) { el.hidden = true; el.style.display = 'none'; }
        
        function toast(message, title = "Ù…Ø¹Ù„ÙˆÙ…Ø©") {
            els.modalTitle.textContent = title;
            els.modalBody.textContent = message;
            els.modal.style.display = 'flex';
        }
        function closeToast() { els.modal.style.display = 'none'; }
        function createConfetti(n = 26, duration = 3400) {
            for (let i = 0; i < n; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = (Math.random() * 100) + '%';
                c.style.backgroundColor = ['#ffd700', '#ff6b35', '#32cd32', '#ff69b4', '#9370db'][Math.floor(Math.random() * 5)];
                c.style.animationDuration = (duration / 1000 + Math.random() * 1.5) + 's';
                c.style.animationDelay = (Math.random() * 1.5) + 's';
                els.celebration.appendChild(c);
                setTimeout(() => c.remove(), duration + 2500);
            }
        }

        /* =======================
          Progress Management
        ======================== */
        function saveProgress() {
            const data = { completedLevels, bestScores };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadProgress() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                if (typeof data.completedLevels === 'number') completedLevels = data.completedLevels;
                if (typeof data.bestScores === 'object') bestScores = data.bestScores;
            } catch (e) {
                console.error("Error loading progress from localStorage:", e);
                // In case of error, just ignore and start fresh
            }
        }
        
        function resetProgress() {
            completedLevels = 0;
            bestScores = {};
            localStorage.removeItem(STORAGE_KEY);
            updateProgressUI();
            toast("ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!", "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·");
        }

        function updateBestScore(level, newScore) {
            bestScores[level] = Math.max(bestScores[level] || 0, newScore);
        }

        /* =======================
          Language Helper Functions
        ======================== */
        function normalizePronoun(p) {
            if (p === "elle") return "il";
            if (p === "elles") return "ils";
            return p;
        }

        function formatJe(pronoun, form) {
            if (pronoun !== "je") return `${pronoun} ${form}`;
            const first = (form || "").charAt(0).toLowerCase();
            const vowels = "aÃ Ã¢Ã¤eÃ©Ã¨ÃªÃ«iÃ®Ã¯oÃ´Ã¶uÃ¹Ã»Ã¼yh";
            if (vowels.includes(first)) return `j'${form}`;
            return `je ${form}`;
        }
        function makeAnswer(pronoun, conj) {
            return formatJe(pronoun, conj);
        }
        function groupLabel(g) {
            if (g === 1) return "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (-er)";
            if (g === 2) return "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (-ir)";
            return "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø´Ø§Ø°Ø©)";
        }
        
        /* =======================
          Question Generation
        ======================== */
        function getAllVerbs() {
            return [...verbDatabase.group1, ...verbDatabase.group2, ...verbDatabase.group3];
        }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffle(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function generateRandomQuestion(level) {
            switch (level) {
                case 1: { // Classification
                    const all = getAllVerbs();
                    const v = pick(all);
                    let gIndex = 1;
                    if (verbDatabase.group2.find(x => x.verb === v.verb)) gIndex = 2;
                    else if (verbDatabase.group3.find(x => x.verb === v.verb)) gIndex = 3;
                    const options = ["Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (-er)", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (-ir)", "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø´Ø§Ø°Ø©)"];
                    return {
                        type: "classify",
                        question: "ØµÙ†Ù‘Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ¹Ù„ Ø­Ø³Ø¨ Ù…Ø¬Ù…ÙˆØ¹ØªÙ‡:",
                        verb: v.verb,
                        options,
                        correctIndex: gIndex - 1,
                        explanation: `${v.verb} ÙŠÙ†ØªÙ…ÙŠ Ø¥Ù„Ù‰ ${groupLabel(gIndex)}`
                    };
                }
                case 2:
                case 3:
                case 4:
                case 5: {
                    const pool = level === 2 ? verbDatabase.group1 :
                                 level === 3 ? verbDatabase.group2 :
                                 level === 4 ? verbDatabase.group3 :
                                 getAllVerbs();
                    const v = pick(pool);
                    const pro = pick(pronouns);
                    const correct = makeAnswer(pro, v.conjugations[normalizePronoun(pro)]);
                    
                    const wrongs = generateSmartWrongAnswers(v, pro, correct);
                    const options = shuffle([correct, ...wrongs]).slice(0, 4);

                    return {
                        type: level === 5 ? "mixed" : "conjugate",
                        question: level === 5 ? "Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ - Ø§Ø®ØªØ± Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­:" : "Ø§Ø®ØªØ± Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­:",
                        display: `${v.verb} + ${pro}`,
                        options,
                        correctAnswer: correct,
                        explanation: `${correct} - Ù‡Ùˆ Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­.`
                    };
                }
                case 6: { // Final Treasure
                    return generateFinalLevelQuestion();
                }
            }
        }

        function generateSmartWrongAnswers(verbObj, pronoun, correct) {
            const wrongSet = new Set();
            const allVerbs = getAllVerbs().filter(v => v.verb !== verbObj.verb);
            const altPronoun = pick(pronouns.filter(p => p !== pronoun));
            const normPronoun = normalizePronoun(pronoun);
            
            // Wrong Answer 1: Same verb, different pronoun
            if (altPronoun) {
                const altConj = verbObj.conjugations[normalizePronoun(altPronoun)];
                if (altConj) wrongSet.add(makeAnswer(altPronoun, altConj));
            }

            // Wrong Answer 2: Different verb, same pronoun
            const otherVerb = pick(allVerbs);
            if (otherVerb) {
                const otherConj = otherVerb.conjugations[normPronoun];
                if (otherConj) wrongSet.add(makeAnswer(pronoun, otherConj));
            }

            // Wrong Answer 3: Infinitive form
            wrongSet.add(`${pronoun} ${verbObj.verb}`);

            // Ensure we have at least 3 unique wrong answers
            while (wrongSet.size < 3) {
                const randomWrong = `Ø®Ø·Ø£ ${Math.random().toString(36).substring(7)}`;
                wrongSet.add(randomWrong);
            }

            const finalWrongs = Array.from(wrongSet).filter(w => w !== correct).slice(0, 3);
            return finalWrongs;
        }

        function generateFinalLevelQuestion() {
            const all = getAllVerbs();
            const v = pick(all);
            const pro = pick(pronouns);
            const correct = makeAnswer(pro, v.conjugations[normalizePronoun(pro)]);

            const wrongs = generateSmartWrongAnswers(v, pro, correct);
            const options = shuffle([correct, ...wrongs]).slice(0, 4);

            return {
                type: "final",
                question: "ğŸ† Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ - Ø§Ø®ØªØ± Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­:",
                display: `${v.verb} + ${pro}`,
                options,
                correctAnswer: correct,
                explanation: `${correct} - ØªØµØ±ÙŠÙ ØµØ­ÙŠØ­ Ù„Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ!`
            };
        }

        /* =======================
          Game Logic
        ======================== */
        function updateProgressUI() {
            const percentage = (completedLevels / 6) * 100;
            els.progressFill.style.width = percentage + '%';
            els.progressText.textContent = `Ø§Ù„ØªÙ‚Ø¯Ù…: ${completedLevels}/6 Ù…Ø±Ø§Ø­Ù„ Ù…ÙƒØªÙ…Ù„Ø©`;

            $$(".map-piece").forEach(piece => {
                const lvl = parseInt(piece.dataset.level, 10);
                const lock = piece.querySelector('.lock-icon');
                const scoreEl = piece.querySelector('.piece-score');
                piece.classList.toggle('completed', lvl <= completedLevels);
                
                if (lvl <= completedLevels) {
                    lock.textContent = 'âœ…';
                } else if (lvl === completedLevels + 1) {
                    lock.textContent = 'ğŸ”“';
                } else {
                    lock.textContent = 'ğŸ”’';
                }

                if (bestScores[lvl]) {
                    scoreEl.textContent = `${bestScores[lvl]}%`;
                    scoreEl.hidden = false;
                } else {
                    scoreEl.hidden = true;
                }
            });
        }

        function openGameScreen() {
            hide(els.mainMap);
            show(els.gameScreen);
        }

        function backToMap() {
            stopTimer();
            show(els.mainMap);
            hide(els.gameScreen);
            els.treasureReveal.style.display = 'none';
            saveProgress();
            updateProgressUI();
        }

        function startLevel(level) {
            if (level > completedLevels + 1 && level !== 6) {
                toast("ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹!", "ØªÙ†Ø¨ÙŠÙ‡");
                return;
            }
            if (level === 6 && completedLevels < 5) {
                toast("ÙŠØ¬Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ!", "ØªÙ†Ø¨ÙŠÙ‡");
                return;
            }
            currentLevel = level;
            currentQuestion = 0;
            score = 0;
            openGameScreen();
            loadQuestion();
        }

        function loadQuestion() {
            const levelData = levels[currentLevel];
            if (!levelData || currentQuestion >= levelData.questionCount) {
                completeLevel();
                return;
            }

            const q = generateRandomQuestion(currentLevel);
            currentQuestionData = q;

            els.levelBadge.textContent = `ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${currentLevel}`;
            els.qBadge.textContent = `â“ Ø§Ù„Ø³Ø¤Ø§Ù„: ${currentQuestion + 1}/${levelData.questionCount}`;
            els.scoreBadge.textContent = `â­ Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;

            els.questionTitle.textContent = q.question;
            els.questionVerb.textContent = q.verb || q.display || '';
            els.questionMeta.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestion + 1} Ù…Ù† ${levelData.questionCount}`;

            els.optionsContainer.innerHTML = '';

            const options = q.options || [];
            options.forEach((optionText, index) => {
                const card = document.createElement('button');
                card.className = 'verb-card';
                card.type = 'button';
                card.setAttribute('role', 'option');
                card.setAttribute('tabindex', '0');
                card.textContent = optionText;
                card.onclick = () => handleAnswer(card, index);
                els.optionsContainer.appendChild(card);
            });

            els.nextButton.style.display = 'none';
            els.treasureReveal.style.display = 'none';
            startTimer(() => handleTimeout());
        }

        function handleAnswer(selectedCard, selectedIndex) {
            stopTimer();
            const q = currentQuestionData;
            const isCorrect = ('correctAnswer' in q) ? (selectedCard.textContent === q.correctAnswer) : (selectedIndex === q.correctIndex);

            $$(".verb-card", els.optionsContainer).forEach(btn => btn.disabled = true);

            if (isCorrect) {
                selectedCard.classList.add('correct');
                score++;
                els.scoreBadge.textContent = `â­ Ø§Ù„Ù†Ù‚Ø§Ø·: ${score}`;
                showTreasureReveal();
                toast(`âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!\n\nğŸ’¡ ${q.explanation || 'Ø£Ø­Ø³Ù†Øª!'}`);
            } else {
                selectedCard.classList.add('incorrect');
                if ('correctAnswer' in q) {
                    $$(".verb-card", els.optionsContainer).forEach(btn => {
                        if (btn.textContent === q.correctAnswer) btn.classList.add('correct');
                    });
                    toast(`âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!\n\nğŸ’¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.correctAnswer}\n\n${q.explanation || ''}`, "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©");
                } else if ('correctIndex' in q) {
                    const correctBtn = $$(".verb-card", els.optionsContainer)[q.correctIndex];
                    if (correctBtn) correctBtn.classList.add('correct');
                    toast(`âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!\n\nğŸ’¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.options[q.correctIndex]}\n\n${q.explanation || ''}`, "Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©");
                }
            }
            els.nextButton.style.display = 'inline-block';
        }

        function handleTimeout() {
            const q = currentQuestionData;
            $$(".verb-card", els.optionsContainer).forEach(btn => btn.disabled = true);
            
            if ('correctAnswer' in q) {
                $$(".verb-card", els.optionsContainer).forEach(btn => {
                    if (btn.textContent === q.correctAnswer) btn.classList.add('correct');
                });
                toast(`â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!\n\nğŸ’¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.correctAnswer}\n\n${q.explanation || ''}`, "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª");
            } else if ('correctIndex' in q) {
                const correctBtn = $$(".verb-card", els.optionsContainer)[q.correctIndex];
                if (correctBtn) correctBtn.classList.add('correct');
                toast(`â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!\n\nğŸ’¡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.options[q.correctIndex]}\n\n${q.explanation || ''}`, "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª");
            }
            els.nextButton.style.display = 'inline-block';
        }
        
        function showTreasureReveal() {
            els.treasureReveal.style.display = 'block';
            createConfetti(26, 3400);
        }

        function nextQuestion() {
            currentQuestion++;
            loadQuestion();
        }

        function completeLevel() {
            stopTimer();
            const levelData = levels[currentLevel];
            const percentage = Math.round((score / levelData.questionCount) * 100);
            
            completedLevels = Math.max(completedLevels, currentLevel);
            updateBestScore(currentLevel, percentage);
            saveProgress();
            
            let message = `ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentLevel}\n\nğŸ† Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${score}/${levelData.questionCount} (${percentage}%)\n\n`;
            if (percentage >= 80) message += "ğŸŒŸ Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²! Ø£Ù†Øª Ø¨Ø·Ù„ Ø§Ù„ØªØµØ±ÙŠÙ!";
            else if (percentage >= 60) message += "ğŸ‘ Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨!";
            else message += "ğŸ’ª ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¦Ùƒ! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!";
            
            message += "\n\nğŸ—ºï¸ ØªÙ… ÙƒØ´Ù Ø¬Ø²Ø¡ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©!";
            toast(message, "Ù…Ø±Ø­Ù„Ø© Ù…ÙƒØªÙ…Ù„Ø©");
            backToMap();

            if (currentLevel === 6) {
                createConfetti(90, 5200);
                toast("ğŸ† Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ!\n\nğŸ‘‘ Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¨Ø·Ù„ Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ÙØ±Ù†Ø³ÙŠ!\n\nğŸ–ï¸ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ÙØ§ØªØ­ Ø§Ù„Ù„ØºÙˆÙŠ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±Ùƒ!", "Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ");
            }
        }
        
        /* =======================
          Timer Management
        ======================== */
        function startTimer(onExpire) {
            clearInterval(timerId);
            timeLeft = QUESTION_TIME;
            updateTimerUI();
            timerId = setInterval(() => {
                timeLeft--;
                updateTimerUI();
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    onExpire?.();
                }
            }, 1000);
        }
        function stopTimer() { clearInterval(timerId); }
        function updateTimerUI() {
            els.timerLabel.textContent = `â³ Ø§Ù„ÙˆÙ‚Øª: ${Math.max(0, timeLeft)} Ø«`;
            const pct = Math.max(0, Math.min(100, (timeLeft / QUESTION_TIME) * 100));
            els.timerFill.style.width = pct + '%';
        }

        /* =======================
          Frenchapeau & Help
        ======================== */
        function toggleSpeech() {
            speechVisible = !speechVisible;
            if (speechVisible) {
                const say = pick(speeches);
                els.speechBubble.textContent = say;
                els.speechBubble.style.display = 'block';
                setTimeout(() => { els.speechBubble.style.display = 'none'; speechVisible = false; }, 4200);
            } else {
                els.speechBubble.style.display = 'none';
            }
        }

        function showHowTo() {
            toast(
`ğŸ¯ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ÙƒÙ†Ø² Ø§Ù„ØªØµØ±ÙŠÙ!
Bienvenue dans le TrÃ©sor des Verbes!

â€¢ Ù„Ø¯ÙŠÙƒ 6 Ù…Ø±Ø§Ø­Ù„ Ù…Ù† Ø§Ù„Ø³Ù‡Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªÙ‚Ø¯Ù….
â€¢ ÙÙŠ ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ø§Ø®ØªØ± Ø§Ù„ØªØµØ±ÙŠÙ Ø§Ù„ØµØ­ÙŠØ­.
â€¢ Ù„Ø¯ÙŠÙƒ ${QUESTION_TIME} Ø«Ø§Ù†ÙŠØ© Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„.
â€¢ ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.
â€¢ Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„ÙØªØ­ Ø§Ù„ÙƒÙ†Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.

Ù†ØµÙŠØ­Ø©: Ø§Ù†ØªØ¨Ù‡ Ù„Ù„ØªØ¹Ø§Ù‚Ø¯ Ù…Ø¹ "je" â†’ "j'..." Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©!`,
                "ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨ - Comment jouer"
            );
        }

        /* =======================
          UI Event Binding
        ======================== */
        function bindMapInteractions() {
            $$(".map-piece").forEach(piece => {
                piece.addEventListener('click', () => {
                    const lv = parseInt(piece.dataset.level, 10);
                    startLevel(lv);
                });
                piece.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        piece.click();
                    }
                });
            });
        }

        function bindUI() {
            els.startAdventureBtn.addEventListener('click', () => startLevel(1));
            els.howToBtn.addEventListener('click', showHowTo);
            els.resetBtn.addEventListener('click', resetProgress);
            els.backBtn.addEventListener('click', backToMap);
            els.nextButton.addEventListener('click', nextQuestion);
            els.tipButton.addEventListener('click', () => {
                const tips = [
                    "Ø§Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØ¹Ù„: -er ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.",
                    "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¹Ø§Ø¯Ø©Ù‹ Ø£ÙØ¹Ø§Ù„ -ir Ù…Ø¹ Ù†Ù‡Ø§ÙŠØ§Øª: -is, -is, -it, -issons, -issez, -issent.",
                    "Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø´Ø§Ø°Ø© Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ãªtre, avoir, aller, faire...",
                    "Ù…Ø¹ je Ù‚Ø¨Ù„ Ø­Ø±Ù Ø¹Ù„Ù‘Ø© Ø£Ùˆ h Ù†ÙƒØªØ¨: j' + Ø§Ù„ØªØµØ±ÙŠÙ (Ù…Ø«Ù„Ø§Ù‹: j'ai)."
                ];
                toast(pick(tips), "ØªÙ„Ù…ÙŠØ­");
            });
            els.helperBtn.addEventListener('click', toggleSpeech);
            els.modalClose.addEventListener('click', closeToast);
            els.modal.addEventListener('click', (e) => { if (e.target === els.modal) closeToast(); });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeToast();
            });
        }

        /* =======================
          Application Bootstrap
        ======================== */
        function init() {
            loadProgress();
            updateProgressUI();
            bindMapInteractions();
            bindUI();
            setTimeout(() => toggleSpeech(), 1000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
