<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة صدى الألوان</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 320px;
            height: 320px;
        }
        @media (max-width: 400px) {
            .game-grid {
                width: 280px;
                height: 280px;
                gap: 15px;
            }
        }
        .grid-cell {
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 4px solid transparent;
        }
        .grid-cell.active {
            transform: scale(0.95);
            filter: brightness(1.5);
            border-color: white;
        }
        .grid-cell:not(.disabled):hover {
            filter: brightness(1.1);
        }
        .disabled {
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="text-center mb-6">
        <h1 class="text-4xl font-bold mb-2 text-cyan-400">لعبة صدى الألوان</h1>
        <p class="text-lg text-gray-300">اختبر قوة ذاكرتك البصرية</p>
    </div>

    <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl w-full max-w-md">
        <!-- لوحة التحكم والمعلومات -->
        <div class="flex justify-between items-center mb-6">
            <div class="text-xl">
                <span>المستوى: </span>
                <span id="level" class="font-bold text-2xl text-yellow-400">0</span>
            </div>
            <div id="message" class="text-lg font-semibold text-center h-12 flex items-center justify-center">اضغط "ابدأ" للعب</div>
            <div class="text-xl">
                <span>أعلى مستوى: </span>
                <span id="high-score" class="font-bold text-2xl text-green-400">0</span>
            </div>
        </div>

        <!-- شبكة اللعبة -->
        <div id="game-container" class="flex justify-center mb-6">
            <div class="game-grid">
                <div class="grid-cell bg-red-500" data-id="0"></div>
                <div class="grid-cell bg-green-500" data-id="1"></div>
                <div class="grid-cell bg-blue-500" data-id="2"></div>
                <div class="grid-cell bg-yellow-500" data-id="3"></div>
            </div>
        </div>

        <!-- زر البدء -->
        <button id="start-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-xl text-xl transition duration-300 shadow-lg">
            ابدأ اللعبة
        </button>
    </div>
    
    <footer class="mt-8 text-gray-500 text-sm">
        <p>Frenchapeau 2025</p>
    </footer>

    <script>
        // --- عناصر واجهة المستخدم ---
        const levelDisplay = document.getElementById('level');
        const highScoreDisplay = document.getElementById('high-score');
        const messageDisplay = document.getElementById('message');
        const startBtn = document.getElementById('start-btn');
        const gridCells = document.querySelectorAll('.grid-cell');
        const gameGrid = document.querySelector('.game-grid');

        // --- متغيرات حالة اللعبة ---
        let level = 0;
        let highScore = localStorage.getItem('colorEchoHighScore') || 0;
        let sequence = [];
        let userSequence = [];
        let isPlayerTurn = false;
        let gameInProgress = false;

        // --- إعدادات الصوت ---
        const synth = new Tone.Synth().toDestination();
        const notes = ["C4", "E4", "G4", "A4"]; // نغمات مختلفة لكل مربع

        // --- وظائف اللعبة ---

        /**
         * تهيئة اللعبة عند البدء
         */
        function startGame() {
            if (gameInProgress) return;
            gameInProgress = true;
            level = 0;
            sequence = [];
            userSequence = [];
            startBtn.classList.add('hidden');
            messageDisplay.textContent = 'استعد...';
            setTimeout(nextRound, 1500);
        }

        /**
         * الانتقال إلى الجولة التالية
         */
        function nextRound() {
            level++;
            levelDisplay.textContent = level;
            messageDisplay.textContent = 'شاهد التسلسل';
            userSequence = [];
            isPlayerTurn = false;
            gameGrid.classList.add('disabled');

            // إضافة عنصر جديد عشوائي إلى التسلسل
            const nextInSequence = Math.floor(Math.random() * 4);
            sequence.push(nextInSequence);
            
            // تشغيل التسلسل للمستخدم
            playSequence();
        }

        /**
         * عرض التسلسل للمستخدم مع وميض وصوت
         */
        function playSequence() {
            let i = 0;
            const interval = setInterval(() => {
                flashCell(sequence[i]);
                i++;
                if (i >= sequence.length) {
                    clearInterval(interval);
                    // السماح للمستخدم باللعب بعد انتهاء التسلسل
                    setTimeout(() => {
                         isPlayerTurn = true;
                         gameGrid.classList.remove('disabled');
                         messageDisplay.textContent = 'دورك الآن!';
                    }, 500);
                }
            }, 800); // سرعة عرض التسلسل
        }

        /**
         * جعل المربع يومض ويصدر صوتاً
         * @param {number} id - معرف المربع
         */
        function flashCell(id) {
            const cell = document.querySelector(`.grid-cell[data-id='${id}']`);
            if (cell) {
                // تفعيل الصوت
                if(Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                synth.triggerAttackRelease(notes[id], "8n");
                
                // تفعيل الوميض
                cell.classList.add('active');
                setTimeout(() => {
                    cell.classList.remove('active');
                }, 400); // مدة الوميض
            }
        }

        /**
         * معالجة نقرة المستخدم
         * @param {Event} event - حدث النقر
         */
        function handleUserClick(event) {
            if (!isPlayerTurn || !event.target.classList.contains('grid-cell')) return;

            const clickedId = parseInt(event.target.dataset.id);
            flashCell(clickedId);
            userSequence.push(clickedId);

            // التحقق من صحة نقرة المستخدم
            checkUserSequence(userSequence.length - 1);
        }

        /**
         * التحقق مما إذا كانت نقرة المستخدم صحيحة
         * @param {number} currentIndex - مؤشر النقرة الحالية
         */
        function checkUserSequence(currentIndex) {
            if (userSequence[currentIndex] !== sequence[currentIndex]) {
                endGame();
                return;
            }

            // إذا أكمل المستخدم التسلسل بنجاح
            if (userSequence.length === sequence.length) {
                if (gameInProgress) {
                    isPlayerTurn = false;
                    gameGrid.classList.add('disabled');
                    messageDisplay.textContent = 'صحيح! استعد للتالي...';
                    setTimeout(nextRound, 1500);
                }
            }
        }
        
        /**
         * إنهاء اللعبة
         */
        function endGame() {
            gameInProgress = false;
            messageDisplay.textContent = 'للأسف! انتهت اللعبة';
            startBtn.textContent = 'العب مرة أخرى';
            startBtn.classList.remove('hidden');
            gameGrid.classList.add('disabled');

            // تحديث أعلى مستوى
            if (level > highScore) {
                highScore = level - 1 > 0 ? level -1 : 0; // أعلى مستوى هو المستوى السابق المكتمل
                localStorage.setItem('colorEchoHighScore', highScore);
                highScoreDisplay.textContent = highScore;
            }
        }

        // --- ربط الأحداث ---
        startBtn.addEventListener('click', startGame);
        gameGrid.addEventListener('click', handleUserClick);
        
        // --- إعدادات أولية ---
        window.onload = () => {
             highScoreDisplay.textContent = highScore;
             gameGrid.classList.add('disabled');
        };

    </script>
</body>
</html>
